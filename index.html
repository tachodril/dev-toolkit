<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dev Toolkit</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234f46e5'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23g)'/%3E%3Ctext x='50' y='68' text-anchor='middle' font-family='system-ui,sans-serif' font-weight='800' font-size='52' fill='white'%3E%E2%9C%A6%3C/text%3E%3C/svg%3E">
<script src="https://cdn.jsdelivr.net/npm/marked@14.1.4/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<style>
/* ═══════════════════════════════════════════════════════════════
   Design System — CSS Custom Properties
   ═══════════════════════════════════════════════════════════════ */
:root {
  --bg-primary: #f0f2f5;
  --bg-card: #ffffff;
  --bg-input: #f8f9fb;
  --bg-hover: #e8eaed;
  --bg-accent: #4f46e5;
  --bg-accent-hover: #4338ca;
  --bg-accent-subtle: #eef2ff;
  --bg-danger: #ef4444;
  --bg-danger-hover: #dc2626;
  --bg-success: #10b981;
  --bg-warning: #f59e0b;
  --text-primary: #1a1a2e;
  --text-secondary: #64748b;
  --text-accent: #4f46e5;
  --text-on-accent: #ffffff;
  --text-on-danger: #ffffff;
  --border: #e2e8f0;
  --border-focus: #4f46e5;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --transition: 0.2s ease;
}

html.dark {
  --bg-primary: #0f1117;
  --bg-card: #1a1b26;
  --bg-input: #1e2030;
  --bg-hover: #282a3a;
  --bg-accent: #6366f1;
  --bg-accent-hover: #818cf8;
  --bg-accent-subtle: #1e1b4b;
  --bg-danger: #ef4444;
  --bg-danger-hover: #f87171;
  --bg-success: #34d399;
  --bg-warning: #fbbf24;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-accent: #a5b4fc;
  --text-on-accent: #ffffff;
  --border: #2d3048;
  --border-focus: #6366f1;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
}

/* ═══════════════════════════════════════════════════════════════
   Reset & Base
   ═══════════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-sans);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
}

/* ═══════════════════════════════════════════════════════════════
   Header
   ═══════════════════════════════════════════════════════════════ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 24px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.header h1 {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--bg-accent), #7c3aed);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-logo {
  font-size: 24px;
  line-height: 1;
}
.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ═══════════════════════════════════════════════════════════════
   Tab Navigation
   ═══════════════════════════════════════════════════════════════ */
.tabs {
  display: flex;
  gap: 4px;
  padding: 12px 24px 0;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  border: none;
  background: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--transition);
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
}
.tab:hover { color: var(--text-primary); background: var(--bg-hover); }
.tab.active { color: var(--text-accent); border-bottom-color: var(--bg-accent); }

/* ═══════════════════════════════════════════════════════════════
   Main Layout
   ═══════════════════════════════════════════════════════════════ */
.main { padding: 20px 24px; max-width: 1600px; margin: 0 auto; }
.tab-content { display: none; }
.tab-content.active { display: block; }

.split-pane {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  min-height: 500px;
}

/* ═══════════════════════════════════════════════════════════════
   Cards & Panels
   ═══════════════════════════════════════════════════════════════ */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-input);
  flex-shrink: 0;
}
.card-header h3 {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
}
.card-header-actions { display: flex; gap: 6px; }
.card-body { padding: 0; flex: 1; display: flex; flex-direction: column; }

/* ═══════════════════════════════════════════════════════════════
   Settings Panel
   ═══════════════════════════════════════════════════════════════ */
.settings-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  margin-bottom: 20px;
  overflow: hidden;
}
.settings-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
  background: var(--bg-input);
  border: none;
  width: 100%;
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font-sans);
}
.settings-toggle:hover { background: var(--bg-hover); }
.settings-toggle .chevron {
  transition: transform var(--transition);
  font-size: 12px;
}
.settings-toggle.open .chevron { transform: rotate(180deg); }
.settings-body {
  display: none;
  padding: 16px;
  border-top: 1px solid var(--border);
}
.settings-body.open { display: block; }
.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
}
.setting-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.setting-group select,
.setting-group input[type="text"],
.setting-group input[type="number"] {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-sans);
  transition: border-color var(--transition);
}
.setting-group select:focus,
.setting-group input:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px var(--bg-accent-subtle);
}
.checkbox-row {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}
.checkbox-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  cursor: pointer;
  color: var(--text-primary);
}
.checkbox-label input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--bg-accent);
}

/* ═══════════════════════════════════════════════════════════════
   Textarea & Output
   ═══════════════════════════════════════════════════════════════ */
.editor-area {
  width: 100%;
  flex: 1;
  min-height: 350px;
  padding: 16px;
  border: none;
  background: transparent;
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  resize: none;
  outline: none;
}
.editor-area::placeholder { color: var(--text-secondary); opacity: 0.6; }
.output-pre {
  flex: 1;
  min-height: 350px;
  padding: 16px;
  margin: 0;
  background: transparent;
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-break: break-all;
  overflow-y: auto;
}

/* ═══════════════════════════════════════════════════════════════
   Stats Bar
   ═══════════════════════════════════════════════════════════════ */
.stats-bar {
  display: flex;
  gap: 16px;
  padding: 8px 16px;
  background: var(--bg-input);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}
.stat {
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}
.stat-value { font-weight: 700; color: var(--text-primary); }
.stat-dot {
  width: 6px; height: 6px; border-radius: 50%;
  display: inline-block;
}
.stat-dot.total { background: var(--bg-accent); }
.stat-dot.unique { background: var(--bg-success); }
.stat-dot.dupes { background: var(--bg-warning); }

/* ═══════════════════════════════════════════════════════════════
   Buttons
   ═══════════════════════════════════════════════════════════════ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
  font-family: var(--font-sans);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.btn:hover { background: var(--bg-hover); box-shadow: var(--shadow-sm); }
.btn-primary {
  background: var(--bg-accent);
  color: var(--text-on-accent);
  border-color: var(--bg-accent);
}
.btn-primary:hover { background: var(--bg-accent-hover); border-color: var(--bg-accent-hover); }
.btn-danger {
  background: var(--bg-danger);
  color: var(--text-on-danger);
  border-color: var(--bg-danger);
}
.btn-danger:hover { background: var(--bg-danger-hover); }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn-icon {
  padding: 6px 8px;
  border: none;
  background: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: var(--radius-sm);
  font-size: 16px;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

/* ═══════════════════════════════════════════════════════════════
   Drag & Drop Overlay
   ═══════════════════════════════════════════════════════════════ */
.drop-overlay {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(79, 70, 229, 0.08);
  border: 2px dashed var(--bg-accent);
  border-radius: var(--radius-lg);
  z-index: 10;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-accent);
  pointer-events: none;
}
.card.drag-over .drop-overlay { display: flex; }

/* ═══════════════════════════════════════════════════════════════
   Toast Notifications
   ═══════════════════════════════════════════════════════════════ */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column-reverse;
  gap: 8px;
}
.toast {
  padding: 12px 20px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast-success { background: #059669; color: white; }
.toast-error { background: #dc2626; color: white; }
.toast-info { background: var(--bg-accent); color: white; }
@keyframes toastIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

/* ═══════════════════════════════════════════════════════════════
   Compare Mode
   ═══════════════════════════════════════════════════════════════ */
.compare-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.compare-result {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}
.compare-result .card { min-height: 200px; }
.result-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
}
.badge-intersection { background: #dbeafe; color: #1d4ed8; }
.badge-only-a { background: #fce7f3; color: #be185d; }
.badge-only-b { background: #d1fae5; color: #065f46; }
.badge-union { background: #fef3c7; color: #92400e; }

html.dark .badge-intersection { background: #1e3a5f; color: #93c5fd; }
html.dark .badge-only-a { background: #4a1942; color: #f9a8d4; }
html.dark .badge-only-b { background: #064e3b; color: #6ee7b7; }
html.dark .badge-union { background: #451a03; color: #fcd34d; }

/* ═══════════════════════════════════════════════════════════════
   Find & Replace
   ═══════════════════════════════════════════════════════════════ */
.fnr-row {
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border);
}
.fnr-row input {
  flex: 1;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 13px;
  font-family: var(--font-mono);
}
.fnr-row input:focus { outline: none; border-color: var(--border-focus); }

/* ═══════════════════════════════════════════════════════════════
   Keyboard Shortcut Hints
   ═══════════════════════════════════════════════════════════════ */
.kbd {
  display: inline-flex;
  align-items: center;
  padding: 1px 5px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg-input);
  font-size: 10px;
  font-family: var(--font-sans);
  color: var(--text-secondary);
  margin-left: 6px;
  line-height: 1.6;
}

/* ═══════════════════════════════════════════════════════════════
   Theme Toggle
   ═══════════════════════════════════════════════════════════════ */
.theme-toggle {
  width: 36px; height: 36px;
  border: 1px solid var(--border);
  border-radius: 50%;
  background: var(--bg-card);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all var(--transition);
  color: var(--text-primary);
}
.theme-toggle:hover { background: var(--bg-hover); box-shadow: var(--shadow-sm); }

/* ═══════════════════════════════════════════════════════════════
   Responsive
   ═══════════════════════════════════════════════════════════════ */
@media (max-width: 900px) {
  .split-pane, .compare-grid { grid-template-columns: 1fr; }
  .settings-grid { grid-template-columns: 1fr 1fr; }
  .header { padding: 12px 16px; }
  .main { padding: 16px; }
  .tabs { padding: 8px 16px 0; overflow-x: auto; }
}
@media (max-width: 550px) {
  .settings-grid { grid-template-columns: 1fr; }
  .header h1 { font-size: 16px; }
}

/* ═══════════════════════════════════════════════════════════════
   JSON Tab
   ═══════════════════════════════════════════════════════════════ */
.json-toolbar {
  display: flex;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  align-items: center;
}
.json-toolbar .separator {
  width: 1px;
  height: 24px;
  background: var(--border);
  margin: 0 4px;
}
.json-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 500;
  border-bottom: 1px solid var(--border);
  min-height: 42px;
}
.json-status.valid { background: #ecfdf5; color: #065f46; }
.json-status.invalid { background: #fef2f2; color: #991b1b; }
.json-status.idle { background: var(--bg-input); color: var(--text-secondary); }
html.dark .json-status.valid { background: #052e16; color: #6ee7b7; }
html.dark .json-status.invalid { background: #450a0a; color: #fca5a5; }
html.dark .json-status.idle { background: var(--bg-input); color: var(--text-secondary); }
.json-status-icon { font-size: 16px; }
.json-error-detail {
  font-family: var(--font-mono);
  font-size: 12px;
  opacity: 0.85;
  margin-left: 8px;
}

/* JSON Syntax Highlighting */
.json-output { position: relative; }
.json-output .json-key { color: #6366f1; }
.json-output .json-string { color: #059669; }
.json-output .json-number { color: #d97706; }
.json-output .json-boolean { color: #dc2626; }
.json-output .json-null { color: #9333ea; }
.json-output .json-bracket { color: var(--text-secondary); }
html.dark .json-output .json-key { color: #a5b4fc; }
html.dark .json-output .json-string { color: #6ee7b7; }
html.dark .json-output .json-number { color: #fbbf24; }
html.dark .json-output .json-boolean { color: #f87171; }
html.dark .json-output .json-null { color: #c084fc; }

/* JSON Tree View */
.json-tree { padding: 16px; font-family: var(--font-mono); font-size: 13px; line-height: 1.7; overflow: auto; flex: 1; }
.json-tree-node { padding-left: 20px; }
.json-tree-key { color: #6366f1; cursor: pointer; }
.json-tree-key:hover { text-decoration: underline; }
html.dark .json-tree-key { color: #a5b4fc; }
.json-tree-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px;
  height: 16px;
  font-size: 10px;
  cursor: pointer;
  color: var(--text-secondary);
  user-select: none;
  border-radius: 3px;
  margin-right: 2px;
  vertical-align: middle;
}
.json-tree-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
.json-tree-collapsed > .json-tree-children { display: none; }
.json-tree-collapsed > .json-tree-line > .json-tree-toggle::after { content: '\25B6'; }
.json-tree-expanded > .json-tree-line > .json-tree-toggle::after { content: '\25BC'; }
.json-tree-preview { color: var(--text-secondary); font-size: 12px; font-style: italic; }
.json-tree-colon { color: var(--text-secondary); margin: 0 4px; }
.json-tree-comma { color: var(--text-secondary); }

/* JSON Path Bar */
.json-path-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 16px;
  background: var(--bg-input);
  border-top: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-secondary);
  min-height: 32px;
  flex-shrink: 0;
}
.json-path-bar code {
  color: var(--text-accent);
  background: var(--bg-accent-subtle);
  padding: 1px 6px;
  border-radius: 4px;
  cursor: pointer;
}
.json-path-bar code:hover { opacity: 0.8; }

/* JSON View Tabs */
.json-view-tabs {
  display: flex;
  gap: 2px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 2px;
}
.json-view-tab {
  padding: 4px 12px;
  font-size: 12px;
  border: none;
  background: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 4px;
  font-family: var(--font-sans);
  font-weight: 500;
  transition: all var(--transition);
}
.json-view-tab:hover { color: var(--text-primary); }
.json-view-tab.active { background: var(--bg-accent); color: var(--text-on-accent); }

/* ═══════════════════════════════════════════════════════════════
   Epoch Converter
   ═══════════════════════════════════════════════════════════════ */
.epoch-layout { display: flex; flex-direction: column; gap: 20px; }
.epoch-now-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
  gap: 12px;
}
.epoch-now-bar .epoch-live {
  font-family: var(--font-mono);
  font-size: 22px;
  font-weight: 700;
  color: var(--text-accent);
  letter-spacing: 1px;
}
.epoch-now-bar .epoch-live-human {
  font-size: 13px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}
.epoch-converter-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
.epoch-section-title {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.epoch-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  align-items: center;
}
.epoch-input-row input,
.epoch-input-row select {
  flex: 1;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 14px;
  transition: border-color var(--transition);
}
.epoch-input-row input:focus,
.epoch-input-row select:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px var(--bg-accent-subtle);
}
.epoch-results {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.epoch-result-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  gap: 8px;
}
.epoch-result-row .epoch-label {
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
  min-width: 80px;
}
.epoch-result-row .epoch-value {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-primary);
  word-break: break-all;
  flex: 1;
  text-align: right;
}
.epoch-result-row .btn-sm { flex-shrink: 0; }
.epoch-quick-btns {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.epoch-quick-btns .btn { font-size: 11px; padding: 4px 8px; }
.epoch-relative {
  margin-top: 12px;
  padding: 12px 16px;
  background: var(--bg-accent-subtle);
  border-radius: var(--radius-sm);
  font-size: 13px;
  color: var(--text-accent);
  font-weight: 500;
}
.epoch-batch-area {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  resize: vertical;
}
.epoch-batch-area:focus {
  outline: none;
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px var(--bg-accent-subtle);
}
.epoch-batch-output {
  margin-top: 12px;
  max-height: 300px;
  overflow-y: auto;
}

@media (max-width: 900px) {
  .epoch-converter-grid { grid-template-columns: 1fr; }
}

/* ═══════════════════════════════════════════════════════════════
   Markdown Tab
   ═══════════════════════════════════════════════════════════════ */
.md-pane {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  min-height: 600px;
}
@media (max-width: 900px) { .md-pane { grid-template-columns: 1fr; } }

.md-drop-zone {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 24px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  background: var(--bg-input);
  cursor: pointer;
  transition: all var(--transition);
  text-align: center;
  gap: 12px;
}
.md-drop-zone:hover, .md-drop-zone.drag-over {
  border-color: var(--bg-accent);
  background: var(--bg-accent-subtle);
}
.md-drop-zone .drop-icon { font-size: 32px; opacity: 0.5; }
.md-drop-zone .drop-text { font-size: 13px; color: var(--text-secondary); }

.md-input-toggle {
  display: flex;
  gap: 2px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 2px;
}
.md-input-toggle button {
  padding: 4px 12px; font-size: 12px; border: none; background: none;
  color: var(--text-secondary); cursor: pointer; border-radius: 4px;
  font-family: var(--font-sans); font-weight: 500; transition: all var(--transition);
}
.md-input-toggle button:hover { color: var(--text-primary); }
.md-input-toggle button.active { background: var(--bg-accent); color: var(--text-on-accent); }

/* Markdown rendered body */
.md-body {
  font-size: 15px; line-height: 1.75; color: var(--text-primary);
  word-wrap: break-word; overflow-y: auto; padding: 20px;
  flex: 1;
}
.md-body h1, .md-body h2, .md-body h3, .md-body h4, .md-body h5, .md-body h6 {
  margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; line-height: 1.3;
}
.md-body h1 { font-size: 1.8em; padding-bottom: 0.3em; border-bottom: 2px solid var(--bg-accent); }
.md-body h2 { font-size: 1.4em; padding-bottom: 0.2em; border-bottom: 1px solid var(--border); }
.md-body h3 { font-size: 1.2em; }
.md-body h4 { font-size: 1.05em; }
.md-body h1:first-child { margin-top: 0; }
.md-body p { margin-bottom: 1em; }
.md-body a { color: var(--text-accent); text-decoration: none; }
.md-body a:hover { text-decoration: underline; }
.md-body strong { font-weight: 700; }
.md-body ul, .md-body ol { margin-bottom: 1em; padding-left: 2em; }
.md-body li { margin-bottom: 0.3em; }
.md-body li > p { margin-bottom: 0.3em; }
.md-body blockquote {
  margin: 0 0 1em 0; padding: 12px 16px;
  border-left: 4px solid var(--bg-accent); background: var(--bg-accent-subtle);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0; color: var(--text-secondary);
}
.md-body blockquote > :last-child { margin-bottom: 0; }
.md-body code {
  font-family: var(--font-mono); background: var(--bg-input);
  padding: 2px 6px; border-radius: 4px; font-size: 0.88em;
  border: 1px solid var(--border);
}
.md-body pre { margin-bottom: 1.25em; border-radius: var(--radius-md); overflow: hidden; background: var(--bg-input); border: 1px solid var(--border); position: relative; }
.md-body pre code { display: block; padding: 16px; overflow-x: auto; font-size: 13px; line-height: 1.6; border: none; background: transparent; border-radius: 0; }
.md-body .code-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 6px 12px; background: var(--bg-hover); border-bottom: 1px solid var(--border);
  font-size: 11px; color: var(--text-secondary);
}
.md-body .code-lang { font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.md-body .copy-btn {
  background: none; border: 1px solid var(--border); color: var(--text-secondary);
  cursor: pointer; padding: 2px 8px; border-radius: 4px; font-size: 11px;
  display: flex; align-items: center; gap: 3px; transition: all var(--transition);
}
.md-body .copy-btn:hover { background: var(--bg-card); color: var(--text-primary); }
.md-body .copy-btn.copied { color: var(--bg-success); border-color: var(--bg-success); }
.md-body table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 1.25em; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; font-size: 13px; }
.md-body th { background: var(--bg-input); font-weight: 600; text-align: left; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
.md-body td { padding: 8px 14px; border-bottom: 1px solid var(--border); }
.md-body tr:last-child td { border-bottom: none; }
.md-body hr { border: none; height: 2px; background: var(--border); border-radius: 1px; margin: 2em 0; }
.md-body img { max-width: 100%; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); margin: 0.5em 0; }
.md-body .task-list-item { list-style: none; margin-left: -1.5em; display: flex; align-items: flex-start; gap: 6px; }
.md-body .task-list-item input[type="checkbox"] { margin-top: 4px; accent-color: var(--bg-accent); }
.md-body mark { background: #fff3bf; padding: 1px 3px; border-radius: 2px; }
html.dark .md-body mark { background: #4d3800; }
.md-body .mermaid-container { margin-bottom: 1.25em; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--bg-input); padding: 20px; overflow-x: auto; text-align: center; }
.md-body .mermaid-container svg { max-width: 100%; height: auto; }

/* hljs within md tab */
.md-body .hljs { background: transparent; color: var(--text-primary); }
.md-body .hljs-keyword, .md-body .hljs-selector-tag { color: #8250df; }
.md-body .hljs-string, .md-body .hljs-doctag { color: #0a3069; }
.md-body .hljs-number { color: #0550ae; }
.md-body .hljs-comment { color: #6e7781; font-style: italic; }
.md-body .hljs-title, .md-body .hljs-title\.function_ { color: #8250df; }
.md-body .hljs-variable { color: #953800; }
.md-body .hljs-type, .md-body .hljs-built_in { color: #0550ae; }
.md-body .hljs-attr { color: #116329; }
.md-body .hljs-tag { color: #0550ae; }
.md-body .hljs-deletion { color: #82071e; }
.md-body .hljs-addition { color: #116329; }
.md-body .hljs-meta { color: #8250df; }
.md-body .hljs-property { color: #116329; }
html.dark .md-body .hljs-keyword, html.dark .md-body .hljs-selector-tag { color: #ff7b72; }
html.dark .md-body .hljs-string, html.dark .md-body .hljs-doctag { color: #a5d6ff; }
html.dark .md-body .hljs-number { color: #79c0ff; }
html.dark .md-body .hljs-comment { color: #8b949e; }
html.dark .md-body .hljs-title, html.dark .md-body .hljs-title\.function_ { color: #d2a8ff; }
html.dark .md-body .hljs-variable { color: #ffa657; }
html.dark .md-body .hljs-type, html.dark .md-body .hljs-built_in { color: #79c0ff; }
html.dark .md-body .hljs-attr { color: #7ee787; }
html.dark .md-body .hljs-tag { color: #79c0ff; }
html.dark .md-body .hljs-deletion { color: #ffa198; }
html.dark .md-body .hljs-addition { color: #7ee787; }
html.dark .md-body .hljs-meta { color: #d2a8ff; }
html.dark .md-body .hljs-property { color: #7ee787; }

/* MD TOC inside tab */
.md-toc { padding: 12px 0; font-size: 13px; }
.md-toc-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 8px; }
.md-toc ul { list-style: none; padding: 0; margin: 0; }
.md-toc a { display: block; padding: 4px 10px; color: var(--text-secondary); text-decoration: none; border-radius: 4px; border-left: 2px solid transparent; transition: all 0.15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.md-toc a:hover { color: var(--text-primary); background: var(--bg-hover); }
.md-toc a.active { color: var(--text-accent); border-left-color: var(--bg-accent); background: var(--bg-accent-subtle); font-weight: 500; }
.md-toc .toc-h2 { padding-left: 22px !important; }
.md-toc .toc-h3 { padding-left: 34px !important; font-size: 12px !important; }
.md-toc .toc-h4 { padding-left: 46px !important; font-size: 12px !important; }

.md-file-info {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 12px; background: var(--bg-accent-subtle);
  border-radius: var(--radius-sm); font-size: 12px; color: var(--text-accent);
  font-weight: 500; margin-bottom: 12px;
}

/* ═══════════════════════════════════════════════════════════════
   Base64 / Encode-Decode Tab
   ═══════════════════════════════════════════════════════════════ */
.enc-mode-bar {
  display: flex; gap: 2px; padding: 2px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
.enc-mode-bar button {
  padding: 6px 14px; font-size: 12px; border: none; background: none;
  color: var(--text-secondary); cursor: pointer; border-radius: 4px;
  font-family: var(--font-sans); font-weight: 500; transition: all var(--transition);
}
.enc-mode-bar button:hover { color: var(--text-primary); }
.enc-mode-bar button.active { background: var(--bg-accent); color: var(--text-on-accent); }
.enc-direction {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 13px; color: var(--text-secondary); font-weight: 500;
}
.enc-direction button {
  padding: 4px 10px; font-size: 12px; border: 1px solid var(--border);
  background: var(--bg-card); color: var(--text-primary); cursor: pointer;
  border-radius: var(--radius-sm); font-family: var(--font-sans); transition: all var(--transition);
}
.enc-direction button:hover { background: var(--bg-hover); }
.enc-direction button.active { background: var(--bg-accent); color: var(--text-on-accent); border-color: var(--bg-accent); }

/* ═══════════════════════════════════════════════════════════════
   Regex Tester Tab
   ═══════════════════════════════════════════════════════════════ */
.regex-pattern-bar {
  display: flex; gap: 8px; align-items: center;
  padding: 14px 16px; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: var(--radius-lg);
  margin-bottom: 16px; box-shadow: var(--shadow-sm); flex-wrap: wrap;
}
.regex-pattern-bar .regex-slash {
  font-family: var(--font-mono); font-size: 20px; color: var(--text-accent);
  font-weight: 300; line-height: 1;
}
.regex-pattern-input {
  flex: 1; min-width: 200px; padding: 8px 12px;
  font-family: var(--font-mono); font-size: 14px;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--bg-input); color: var(--text-primary); transition: border-color var(--transition);
}
.regex-pattern-input:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--bg-accent-subtle); }
.regex-flags { display: flex; gap: 3px; }
.regex-flag {
  width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-size: 13px; font-weight: 600;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  background: var(--bg-card); color: var(--text-secondary); cursor: pointer; transition: all var(--transition);
}
.regex-flag:hover { background: var(--bg-hover); }
.regex-flag.active { background: var(--bg-accent); color: var(--text-on-accent); border-color: var(--bg-accent); }
.regex-match-hl { background: rgba(99,102,241,0.25); border-radius: 2px; padding: 0 1px; }
.regex-match-hl.group-1 { background: rgba(16,185,129,0.25); }
.regex-match-hl.group-2 { background: rgba(245,158,11,0.25); }
.regex-match-hl.group-3 { background: rgba(239,68,68,0.25); }
.regex-matches-list {
  max-height: 250px; overflow-y: auto; font-family: var(--font-mono); font-size: 13px;
}
.regex-match-item {
  display: flex; gap: 8px; padding: 6px 12px; border-bottom: 1px solid var(--border); align-items: baseline;
}
.regex-match-item:last-child { border-bottom: none; }
.regex-match-idx {
  font-size: 10px; font-weight: 700; color: var(--text-secondary);
  background: var(--bg-input); padding: 1px 6px; border-radius: 3px; white-space: nowrap;
}
.regex-match-val { word-break: break-all; }
.regex-match-group { color: var(--text-secondary); font-size: 12px; }
.regex-library {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 8px; max-height: 300px; overflow-y: auto; padding: 12px;
}
.regex-lib-item {
  padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
  cursor: pointer; transition: all var(--transition); font-size: 12px;
}
.regex-lib-item:hover { background: var(--bg-hover); border-color: var(--border-focus); }
.regex-lib-item .lib-name { font-weight: 600; margin-bottom: 2px; }
.regex-lib-item .lib-pattern { font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary); word-break: break-all; }

/* ═══════════════════════════════════════════════════════════════
   JWT Decoder Tab
   ═══════════════════════════════════════════════════════════════ */
.jwt-parts { display: flex; flex-direction: column; gap: 16px; }
.jwt-part-card {
  border: 1px solid var(--border); border-radius: var(--radius-lg);
  overflow: hidden; box-shadow: var(--shadow-sm);
}
.jwt-part-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; font-size: 13px; font-weight: 600;
}
.jwt-header-part .jwt-part-header { background: #dbeafe; color: #1e40af; }
.jwt-payload-part .jwt-part-header { background: #ede9fe; color: #5b21b6; }
.jwt-sig-part .jwt-part-header { background: #d1fae5; color: #065f46; }
html.dark .jwt-header-part .jwt-part-header { background: #1e3a5f; color: #93c5fd; }
html.dark .jwt-payload-part .jwt-part-header { background: #2e1065; color: #c4b5fd; }
html.dark .jwt-sig-part .jwt-part-header { background: #064e3b; color: #6ee7b7; }
.jwt-part-body { padding: 12px 16px; background: var(--bg-card); }
.jwt-part-body pre {
  margin: 0; font-family: var(--font-mono); font-size: 13px;
  line-height: 1.6; white-space: pre-wrap; word-break: break-all;
}
.jwt-raw-token {
  font-family: var(--font-mono); font-size: 13px; line-height: 1.5;
  word-break: break-all; padding: 16px;
}
.jwt-raw-token .jwt-header-seg { color: #2563eb; }
.jwt-raw-token .jwt-payload-seg { color: #7c3aed; }
.jwt-raw-token .jwt-sig-seg { color: #059669; }
html.dark .jwt-raw-token .jwt-header-seg { color: #93c5fd; }
html.dark .jwt-raw-token .jwt-payload-seg { color: #c4b5fd; }
html.dark .jwt-raw-token .jwt-sig-seg { color: #6ee7b7; }
.jwt-dot { color: var(--text-secondary); font-weight: 700; }
.jwt-claims-table { width: 100%; font-size: 13px; }
.jwt-claims-table td { padding: 6px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
.jwt-claims-table td:first-child { font-weight: 600; color: var(--text-secondary); white-space: nowrap; width: 100px; }
.jwt-claims-table tr:last-child td { border-bottom: none; }
.jwt-expiry-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
}
.jwt-expiry-valid { background: #d1fae5; color: #065f46; }
.jwt-expiry-expired { background: #fee2e2; color: #991b1b; }
html.dark .jwt-expiry-valid { background: #064e3b; color: #6ee7b7; }
html.dark .jwt-expiry-expired { background: #450a0a; color: #fca5a5; }

/* ═══════════════════════════════════════════════════════════════
   Diff Viewer Tab
   ═══════════════════════════════════════════════════════════════ */
.diff-options {
  display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
  margin-bottom: 16px;
}
.diff-output {
  font-family: var(--font-mono); font-size: 13px; line-height: 1.7;
  border: 1px solid var(--border); border-radius: var(--radius-lg);
  overflow: hidden; background: var(--bg-card); box-shadow: var(--shadow-sm);
}
.diff-line {
  display: flex; border-bottom: 1px solid var(--border); min-height: 24px;
}
.diff-line:last-child { border-bottom: none; }
.diff-gutter {
  width: 50px; min-width: 50px; padding: 1px 8px; text-align: right;
  color: var(--text-secondary); font-size: 11px; background: var(--bg-input);
  border-right: 1px solid var(--border); user-select: none; flex-shrink: 0;
}
.diff-content { padding: 1px 12px; flex: 1; white-space: pre-wrap; word-break: break-all; }
.diff-line-add { background: rgba(16,185,129,0.1); }
.diff-line-add .diff-gutter { background: rgba(16,185,129,0.15); color: #065f46; }
.diff-line-add .diff-content { color: #065f46; }
.diff-line-del { background: rgba(239,68,68,0.1); }
.diff-line-del .diff-gutter { background: rgba(239,68,68,0.15); color: #991b1b; }
.diff-line-del .diff-content { color: #991b1b; }
html.dark .diff-line-add { background: rgba(16,185,129,0.08); }
html.dark .diff-line-add .diff-gutter { background: rgba(16,185,129,0.12); color: #6ee7b7; }
html.dark .diff-line-add .diff-content { color: #6ee7b7; }
html.dark .diff-line-del { background: rgba(239,68,68,0.08); }
html.dark .diff-line-del .diff-gutter { background: rgba(239,68,68,0.12); color: #fca5a5; }
html.dark .diff-line-del .diff-content { color: #fca5a5; }
.diff-line-ctx .diff-content { color: var(--text-secondary); }
.diff-char-add { background: rgba(16,185,129,0.3); border-radius: 2px; }
.diff-char-del { background: rgba(239,68,68,0.3); border-radius: 2px; }
.diff-stats-bar {
  display: flex; gap: 16px; padding: 10px 16px;
  border-bottom: 1px solid var(--border); background: var(--bg-input); font-size: 12px;
}
.diff-stat-add { color: #059669; font-weight: 700; }
.diff-stat-del { color: #dc2626; font-weight: 700; }
.diff-stat-same { color: var(--text-secondary); }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
</style>
</head>
<body>

<!-- ═══════════════════ HEADER ═══════════════════ -->
<header class="header">
  <div class="header-left">
    <span class="header-logo">&#x2666;</span>
    <h1>Dev Toolkit</h1>
  </div>
  <div class="header-right">
    <button class="btn btn-sm" onclick="showShortcuts()" title="Keyboard shortcuts">&#x2328; Shortcuts</button>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn" title="Toggle dark mode (Ctrl+D)">&#x263E;</button>
  </div>
</header>

<!-- ═══════════════════ TABS ═══════════════════ -->
<nav class="tabs">
  <button class="tab active" data-tab="format" onclick="switchTab('format')">&#x270E; Format</button>
  <button class="tab" data-tab="json" onclick="switchTab('json')">{} JSON</button>
  <button class="tab" data-tab="markdown" onclick="switchTab('markdown')">&#x2193; Markdown</button>
  <button class="tab" data-tab="epoch" onclick="switchTab('epoch')">&#x231A; Epoch</button>
  <button class="tab" data-tab="base64" onclick="switchTab('base64')">&#x1F510; Encode/Decode</button>
  <button class="tab" data-tab="regex" onclick="switchTab('regex')">&#x002A; Regex</button>
  <button class="tab" data-tab="jwt" onclick="switchTab('jwt')">&#x1F511; JWT</button>
  <button class="tab" data-tab="diff" onclick="switchTab('diff')">&#x00B1; Diff</button>
  <button class="tab" data-tab="compare" onclick="switchTab('compare')">&#x21C4; Compare Lists</button>
</nav>

<!-- ═══════════════════ MAIN ═══════════════════ -->
<div class="main">

  <!-- ═══════════ FORMAT TAB ═══════════ -->
  <div class="tab-content active" id="tab-format">

    <!-- Settings Panel -->
    <div class="settings-panel">
      <button class="settings-toggle open" onclick="toggleSettings(this)">
        <span>&#x2699; Settings &amp; Processing Options</span>
        <span class="chevron">&#x25BC;</span>
      </button>
      <div class="settings-body open">
        <div class="settings-grid">
          <div class="setting-group">
            <label>Output Format</label>
            <select id="outputFormat" onchange="onSettingChange()">
              <option value="sql-string">SQL IN (strings)</option>
              <option value="sql-numeric">SQL IN (numeric)</option>
              <option value="csv-quoted">CSV (quoted)</option>
              <option value="comma">Comma-separated</option>
              <option value="json">JSON Array</option>
              <option value="python">Python List</option>
              <option value="markdown">Markdown List</option>
              <option value="lines">One Per Line</option>
              <option value="custom">Custom Template</option>
            </select>
          </div>
          <div class="setting-group">
            <label>Sort</label>
            <select id="sortMode" onchange="onSettingChange()">
              <option value="none">None (preserve order)</option>
              <option value="asc">A &#x2192; Z</option>
              <option value="desc">Z &#x2192; A</option>
              <option value="numeric">Numeric</option>
            </select>
          </div>
          <div class="setting-group">
            <label>Case</label>
            <select id="caseMode" onchange="onSettingChange()">
              <option value="asis">As-is</option>
              <option value="upper">UPPERCASE</option>
              <option value="lower">lowercase</option>
            </select>
          </div>
          <div class="setting-group">
            <label>Chunk Size (0 = off)</label>
            <input type="number" id="chunkSize" value="0" min="0" onchange="onSettingChange()">
          </div>
          <div class="setting-group">
            <label>Column Name (SQL)</label>
            <input type="text" id="colName" placeholder="e.g. user_id" oninput="onSettingChange()">
          </div>
          <div class="setting-group">
            <label>Prefix Per Item</label>
            <input type="text" id="prefix" placeholder="e.g. ID_" oninput="onSettingChange()">
          </div>
          <div class="setting-group">
            <label>Suffix Per Item</label>
            <input type="text" id="suffix" placeholder="" oninput="onSettingChange()">
          </div>
          <div class="setting-group">
            <label>Filter Regex</label>
            <input type="text" id="filterRegex" placeholder="e.g. ^ABC" oninput="onSettingChange()">
          </div>
          <div class="setting-group">
            <label>Custom Template</label>
            <input type="text" id="customTpl" placeholder="'{value}'," oninput="onSettingChange()">
          </div>
        </div>
        <div class="checkbox-row">
          <label class="checkbox-label"><input type="checkbox" id="dedup" checked onchange="onSettingChange()"> Remove duplicates</label>
          <label class="checkbox-label"><input type="checkbox" id="trimWs" checked onchange="onSettingChange()"> Trim whitespace</label>
          <label class="checkbox-label"><input type="checkbox" id="livePreview" checked onchange="onSettingChange()"> Live preview</label>
          <label class="checkbox-label"><input type="checkbox" id="filterInvert" onchange="onSettingChange()"> Invert filter</label>
        </div>
      </div>
    </div>

    <!-- Find & Replace -->
    <div class="fnr-row">
      <span style="font-size:13px;color:var(--text-secondary);white-space:nowrap;">Find &amp; Replace:</span>
      <input type="text" id="fnrFind" placeholder="Find (regex)..." oninput="onSettingChange()">
      <span style="color:var(--text-secondary);">&#x2192;</span>
      <input type="text" id="fnrReplace" placeholder="Replace with..." oninput="onSettingChange()">
    </div>

    <!-- Split Pane -->
    <div class="split-pane">
      <!-- Input -->
      <div class="card" id="inputCard" style="position:relative;">
        <div class="drop-overlay">&#x1F4C2; Drop file here</div>
        <div class="card-header">
          <h3>&#x2B9C; Input</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="swapPanes()" title="Swap input ↔ output">&#x21C5; Swap</button>
            <button class="btn btn-sm" onclick="clearInput()" title="Clear input">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="input" placeholder="Paste your raw IDs here...&#10;&#10;Supports:&#10;  - One per line&#10;  - Comma separated&#10;  - Tab separated&#10;  - JSON arrays&#10;  - SQL IN clauses&#10;  - Mixed quotes&#10;&#10;Or drag & drop a .txt / .csv file" spellcheck="false"></textarea>
        </div>
        <div class="stats-bar" id="inputStats">
          <span class="stat"><span class="stat-dot total"></span> Lines: <span class="stat-value" id="statLines">0</span></span>
          <span class="stat"><span class="stat-dot"></span> Chars: <span class="stat-value" id="statChars">0</span></span>
        </div>
      </div>

      <!-- Output -->
      <div class="card">
        <div class="card-header">
          <h3>&#x2B9E; Output</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm btn-primary" onclick="copyOutput()" title="Copy output (Ctrl+Shift+C)">&#x2398; Copy</button>
            <button class="btn btn-sm" onclick="downloadOutput()" title="Download output">&#x21E9; Export</button>
            <button class="btn btn-sm" onclick="clearOutput()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <pre class="output-pre" id="output"></pre>
        </div>
        <div class="stats-bar" id="outputStats">
          <span class="stat"><span class="stat-dot total"></span> Total: <span class="stat-value" id="statTotal">0</span></span>
          <span class="stat"><span class="stat-dot unique"></span> Unique: <span class="stat-value" id="statUnique">0</span></span>
          <span class="stat"><span class="stat-dot dupes"></span> Dupes removed: <span class="stat-value" id="statDupes">0</span></span>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div style="display:flex;gap:8px;margin-top:16px;justify-content:center;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="formatInput()" style="padding:12px 32px;font-size:15px;">&#x26A1; Format<span class="kbd">Ctrl+Enter</span></button>
    </div>
  </div>

  <!-- ═══════════ JSON TAB ═══════════ -->
  <div class="tab-content" id="tab-json">
    <div class="split-pane">
      <!-- JSON Input -->
      <div class="card" id="jsonInputCard" style="position:relative;">
        <div class="drop-overlay">&#x1F4C2; Drop .json file here</div>
        <div class="card-header">
          <h3>{} JSON Input</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="jsonLoadSample()" title="Load sample JSON">&#x2606; Sample</button>
            <button class="btn btn-sm" onclick="jsonFixInput()" title="Attempt to fix common JSON issues">&#x1F527; Auto-fix</button>
            <button class="btn btn-sm" onclick="document.getElementById('jsonInput').value='';jsonClearOutput()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="jsonInput" placeholder="Paste your JSON here...&#10;&#10;Supports:&#10;  - Objects &amp; arrays&#10;  - Nested structures&#10;  - Auto-fix trailing commas&#10;  - Auto-fix single quotes&#10;&#10;Or drag &amp; drop a .json file" spellcheck="false" style="min-height:400px;"></textarea>
        </div>
        <div class="stats-bar">
          <span class="stat">Size: <span class="stat-value" id="jsonInputSize">0 B</span></span>
          <span class="stat">Lines: <span class="stat-value" id="jsonInputLines">0</span></span>
        </div>
      </div>

      <!-- JSON Output -->
      <div class="card">
        <div class="card-header">
          <h3>&#x2B9E; Output</h3>
          <div class="card-header-actions">
            <div class="json-view-tabs">
              <button class="json-view-tab active" data-jview="formatted" onclick="jsonSwitchView('formatted')">Formatted</button>
              <button class="json-view-tab" data-jview="minified" onclick="jsonSwitchView('minified')">Minified</button>
              <button class="json-view-tab" data-jview="tree" onclick="jsonSwitchView('tree')">Tree</button>
            </div>
          </div>
        </div>
        <!-- Toolbar -->
        <div class="json-toolbar">
          <label style="font-size:12px;font-weight:600;color:var(--text-secondary);">INDENT</label>
          <select id="jsonIndent" onchange="jsonFormatNow()" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:12px;">
            <option value="2">2 spaces</option>
            <option value="4">4 spaces</option>
            <option value="tab">Tab</option>
          </select>
          <span class="separator"></span>
          <label class="checkbox-label" style="font-size:12px;"><input type="checkbox" id="jsonSortKeys" onchange="jsonFormatNow()" style="width:14px;height:14px;"> Sort keys</label>
          <span class="separator"></span>
          <button class="btn btn-sm btn-primary" onclick="jsonCopyOutput()">&#x2398; Copy</button>
          <button class="btn btn-sm" onclick="jsonDownload()">&#x21E9; Export</button>
        </div>
        <!-- Status -->
        <div class="json-status idle" id="jsonStatus">
          <span class="json-status-icon">&#x24D8;</span>
          <span>Paste JSON and it will be validated automatically</span>
        </div>
        <!-- Views -->
        <div class="card-body" style="position:relative;">
          <div id="jsonViewFormatted" class="json-view-content" style="display:flex;flex-direction:column;flex:1;">
            <pre class="output-pre json-output" id="jsonOutput" style="flex:1;min-height:300px;"></pre>
          </div>
          <div id="jsonViewMinified" class="json-view-content" style="display:none;flex-direction:column;flex:1;">
            <pre class="output-pre" id="jsonMinified" style="flex:1;min-height:300px;word-break:break-all;"></pre>
          </div>
          <div id="jsonViewTree" class="json-view-content" style="display:none;flex-direction:column;flex:1;">
            <div class="json-tree" id="jsonTree" style="min-height:300px;"></div>
          </div>
        </div>
        <div class="json-path-bar" id="jsonPathBar">
          <span>Path:</span> <code id="jsonPathDisplay">$</code>
        </div>
        <div class="stats-bar">
          <span class="stat"><span class="stat-dot total"></span> Keys: <span class="stat-value" id="jsonStatKeys">0</span></span>
          <span class="stat"><span class="stat-dot unique"></span> Depth: <span class="stat-value" id="jsonStatDepth">0</span></span>
          <span class="stat"><span class="stat-dot dupes"></span> Size: <span class="stat-value" id="jsonStatSize">0 B</span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════ MARKDOWN TAB ═══════════ -->
  <div class="tab-content" id="tab-markdown">
    <!-- Toolbar -->
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <div class="md-input-toggle" id="mdInputToggle">
        <button class="active" data-mode="write" onclick="mdSwitchInput('write')">&#x270E; Write</button>
        <button data-mode="upload" onclick="mdSwitchInput('upload')">&#x1F4C2; Upload File</button>
      </div>
      <span style="color:var(--text-secondary);font-size:12px;">Live preview with syntax highlighting, mermaid diagrams, tables &amp; more</span>
      <div style="flex:1;"></div>
      <button class="btn btn-sm" onclick="mdLoadSample()">&#x2606; Sample</button>
      <button class="btn btn-sm" onclick="mdCopyHtml()">&#x2398; Copy HTML</button>
      <button class="btn btn-sm" onclick="mdDownloadHtml()">&#x21E9; Export HTML</button>
    </div>

    <div class="md-pane">
      <!-- Input Side -->
      <div class="card" id="mdInputCard" style="position:relative;">
        <div class="drop-overlay">&#x1F4C2; Drop .md file here</div>
        <div class="card-header">
          <h3>&#x2B9C; Markdown Input</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="mdClear()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Write mode -->
          <div id="mdWriteMode">
            <textarea class="editor-area" id="mdInput" placeholder="# Hello World&#10;&#10;Write your **markdown** here...&#10;&#10;Supports:&#10;- GFM (tables, task lists, strikethrough)&#10;- Code blocks with syntax highlighting&#10;- Mermaid diagrams&#10;- And much more!" spellcheck="false" style="min-height:500px;"></textarea>
          </div>
          <!-- Upload mode -->
          <div id="mdUploadMode" style="display:none;padding:16px;flex:1;display:none;flex-direction:column;gap:16px;">
            <div class="md-drop-zone" id="mdDropZone" onclick="document.getElementById('mdFileInput').click()">
              <div class="drop-icon">&#x1F4C4;</div>
              <div style="font-weight:600;font-size:14px;">Drop a .md file here or click to browse</div>
              <div class="drop-text">Supports .md, .markdown, .txt files</div>
            </div>
            <input type="file" id="mdFileInput" accept=".md,.markdown,.mdown,.mkdn,.mkd,.txt" hidden>
            <div class="md-file-info" id="mdFileInfo" style="display:none;">
              <span>&#x1F4C4;</span>
              <span id="mdFileName">—</span>
              <div style="flex:1;"></div>
              <button class="btn btn-sm" onclick="mdSwitchInput('write')" style="font-size:11px;">Edit source</button>
            </div>
          </div>
        </div>
        <div class="stats-bar">
          <span class="stat">Lines: <span class="stat-value" id="mdStatLines">0</span></span>
          <span class="stat">Words: <span class="stat-value" id="mdStatWords">0</span></span>
          <span class="stat">Chars: <span class="stat-value" id="mdStatChars">0</span></span>
        </div>
      </div>

      <!-- Preview Side -->
      <div class="card" style="display:flex;flex-direction:column;">
        <div class="card-header">
          <h3>&#x2B9E; Preview</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="mdToggleToc()" id="mdTocToggleBtn">&#x2630; TOC</button>
          </div>
        </div>
        <div class="card-body" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
          <!-- TOC (collapsible) -->
          <div class="md-toc" id="mdToc" style="display:none;padding:12px 16px;border-bottom:1px solid var(--border);max-height:200px;overflow-y:auto;">
            <div class="md-toc-title">Table of Contents</div>
            <ul id="mdTocList"></ul>
          </div>
          <!-- Rendered output -->
          <div class="md-body" id="mdPreview" style="flex:1;overflow-y:auto;min-height:400px;">
            <p style="color:var(--text-secondary);font-style:italic;">Start typing markdown to see the preview...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════ EPOCH TAB ═══════════ -->
  <div class="tab-content" id="tab-epoch">
    <div class="epoch-layout">

      <!-- Live Clock -->
      <div class="epoch-now-bar">
        <div>
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;color:var(--text-secondary);margin-bottom:4px;">Current Unix Timestamp</div>
          <div class="epoch-live" id="epochLive">—</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;color:var(--text-secondary);margin-bottom:4px;">Human Readable (Local)</div>
          <div class="epoch-live-human" id="epochLiveHuman">—</div>
          <div class="epoch-live-human" id="epochLiveUTC" style="margin-top:2px;font-size:11px;">—</div>
        </div>
        <div>
          <button class="btn btn-sm btn-primary" onclick="epochCopyNow()">&#x2398; Copy Timestamp</button>
        </div>
      </div>

      <div class="epoch-converter-grid">
        <!-- Epoch → Human -->
        <div class="card">
          <div class="card-header">
            <h3>&#x1F552; Epoch &#x2192; Human Date</h3>
          </div>
          <div class="card-body" style="padding:16px;">
            <div class="epoch-section-title">Enter a Unix timestamp</div>
            <div class="epoch-input-row">
              <input type="text" id="epochToHumanInput" placeholder="e.g. 1700000000" oninput="epochToHuman()">
              <select id="epochToHumanUnit" onchange="epochToHuman()" style="max-width:120px;">
                <option value="auto">Auto-detect</option>
                <option value="s">Seconds</option>
                <option value="ms">Milliseconds</option>
                <option value="us">Microseconds</option>
                <option value="ns">Nanoseconds</option>
              </select>
            </div>
            <div class="epoch-quick-btns">
              <button class="btn" onclick="epochSetQuick(0)">Epoch 0</button>
              <button class="btn" onclick="epochSetQuick(Date.now()/1000|0)">Now</button>
              <button class="btn" onclick="epochSetQuick(Date.now()/1000+3600|0)">+1 hour</button>
              <button class="btn" onclick="epochSetQuick(Date.now()/1000+86400|0)">+1 day</button>
              <button class="btn" onclick="epochSetQuick(2147483647)">Y2K38</button>
            </div>
            <div class="epoch-results" id="epochToHumanResults" style="margin-top:16px;"></div>
            <div class="epoch-relative" id="epochRelative" style="display:none;"></div>
          </div>
        </div>

        <!-- Human → Epoch -->
        <div class="card">
          <div class="card-header">
            <h3>&#x1F4C5; Human Date &#x2192; Epoch</h3>
          </div>
          <div class="card-body" style="padding:16px;">
            <div class="epoch-section-title">Enter a date/time</div>
            <div class="epoch-input-row">
              <input type="datetime-local" id="humanToEpochInput" onchange="humanToEpoch()" step="1">
            </div>
            <div class="epoch-input-row">
              <input type="text" id="humanToEpochText" placeholder="Or type: 2024-01-15, Jan 15 2024, ISO 8601..." oninput="humanToEpochFromText()">
            </div>
            <div class="epoch-quick-btns">
              <button class="btn" onclick="humanSetQuick('now')">Now</button>
              <button class="btn" onclick="humanSetQuick('today')">Today midnight</button>
              <button class="btn" onclick="humanSetQuick('tomorrow')">Tomorrow midnight</button>
              <button class="btn" onclick="humanSetQuick('week')">+1 week</button>
              <button class="btn" onclick="humanSetQuick('month')">+1 month</button>
              <button class="btn" onclick="humanSetQuick('year')">+1 year</button>
            </div>
            <div class="epoch-results" id="humanToEpochResults" style="margin-top:16px;"></div>
          </div>
        </div>
      </div>

      <!-- Batch Converter -->
      <div class="card">
        <div class="card-header">
          <h3>&#x26A1; Batch Convert</h3>
          <div class="card-header-actions">
            <select id="epochBatchDir" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg-card);color:var(--text-primary);font-size:12px;">
              <option value="toHuman">Epoch &#x2192; Human</option>
              <option value="toEpoch">Human &#x2192; Epoch</option>
            </select>
            <button class="btn btn-sm btn-primary" onclick="epochBatchConvert()">Convert All</button>
            <button class="btn btn-sm" onclick="epochBatchCopy()">&#x2398; Copy Results</button>
          </div>
        </div>
        <div class="card-body" style="padding:16px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div>
              <div class="epoch-section-title">Input (one per line)</div>
              <textarea class="epoch-batch-area" id="epochBatchInput" placeholder="Paste timestamps or dates, one per line...&#10;&#10;1700000000&#10;1609459200&#10;1234567890"></textarea>
            </div>
            <div>
              <div class="epoch-section-title">Output</div>
              <pre class="epoch-batch-area" id="epochBatchOutput" style="overflow-y:auto;white-space:pre-wrap;"></pre>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ═══════════ BASE64 / ENCODE-DECODE TAB ═══════════ -->
  <div class="tab-content" id="tab-base64">
    <!-- Mode Selector -->
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <div class="enc-mode-bar" id="encModeBar">
        <button class="active" data-mode="base64" onclick="encSwitchMode('base64')">Base64</button>
        <button data-mode="url" onclick="encSwitchMode('url')">URL Encode</button>
        <button data-mode="html" onclick="encSwitchMode('html')">HTML Entities</button>
      </div>
      <span class="separator" style="width:1px;height:24px;background:var(--border);"></span>
      <div class="enc-direction">
        <button class="active" id="encBtnEncode" onclick="encSetDir('encode')">Encode</button>
        <button id="encBtnDecode" onclick="encSetDir('decode')">Decode</button>
      </div>
      <div style="flex:1;"></div>
      <label class="checkbox-label" style="font-size:12px;"><input type="checkbox" id="encLive" checked onchange="encProcess()" style="width:14px;height:14px;"> Live</label>
    </div>

    <div class="split-pane">
      <!-- Input -->
      <div class="card">
        <div class="card-header">
          <h3>&#x2B9C; Input</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="encSwap()" title="Swap input ↔ output">&#x21C5; Swap</button>
            <button class="btn btn-sm" onclick="document.getElementById('encInput').value='';encProcess()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="encInput" placeholder="Enter text to encode or decode..." spellcheck="false" style="min-height:300px;" oninput="if(document.getElementById('encLive').checked)encProcess()"></textarea>
        </div>
        <div class="stats-bar">
          <span class="stat">Chars: <span class="stat-value" id="encInputChars">0</span></span>
          <span class="stat">Bytes: <span class="stat-value" id="encInputBytes">0</span></span>
        </div>
      </div>
      <!-- Output -->
      <div class="card">
        <div class="card-header">
          <h3>&#x2B9E; Output</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm btn-primary" onclick="encCopy()">&#x2398; Copy</button>
          </div>
        </div>
        <div class="card-body">
          <pre class="output-pre" id="encOutput" style="min-height:300px;"></pre>
        </div>
        <div class="stats-bar">
          <span class="stat">Chars: <span class="stat-value" id="encOutputChars">0</span></span>
          <span class="stat">Bytes: <span class="stat-value" id="encOutputBytes">0</span></span>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;justify-content:center;">
      <button class="btn btn-primary" onclick="encProcess()" style="padding:12px 32px;font-size:15px;">&#x26A1; Convert</button>
    </div>
  </div>

  <!-- ═══════════ REGEX TESTER TAB ═══════════ -->
  <div class="tab-content" id="tab-regex">
    <!-- Pattern Bar -->
    <div class="regex-pattern-bar">
      <span class="regex-slash">/</span>
      <input class="regex-pattern-input" id="regexPattern" placeholder="Enter regex pattern..." oninput="regexTest()">
      <span class="regex-slash">/</span>
      <div class="regex-flags">
        <button class="regex-flag active" data-flag="g" onclick="regexToggleFlag(this)" title="Global">g</button>
        <button class="regex-flag" data-flag="i" onclick="regexToggleFlag(this)" title="Case insensitive">i</button>
        <button class="regex-flag" data-flag="m" onclick="regexToggleFlag(this)" title="Multiline">m</button>
        <button class="regex-flag" data-flag="s" onclick="regexToggleFlag(this)" title="Dotall">s</button>
      </div>
      <span class="separator" style="width:1px;height:24px;background:var(--border);margin:0 4px;"></span>
      <span class="stat" id="regexMatchCount" style="font-size:13px;font-weight:600;">0 matches</span>
    </div>

    <div class="split-pane" style="min-height:400px;">
      <!-- Test String -->
      <div class="card">
        <div class="card-header">
          <h3>Test String</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="document.getElementById('regexTestStr').value='';regexTest()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body" style="position:relative;">
          <div class="output-pre" id="regexHighlight" style="position:absolute;inset:0;padding:16px;pointer-events:none;white-space:pre-wrap;word-break:break-all;color:transparent;z-index:1;overflow:auto;"></div>
          <textarea class="editor-area" id="regexTestStr" placeholder="Enter test string..." spellcheck="false" style="min-height:300px;position:relative;z-index:2;background:transparent;color:var(--text-primary);caret-color:var(--text-primary);" oninput="regexTest()" onscroll="document.getElementById('regexHighlight').scrollTop=this.scrollTop"></textarea>
        </div>
      </div>
      <!-- Results -->
      <div class="card">
        <div class="card-header">
          <h3>Matches</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="regexCopyMatches()">&#x2398; Copy All</button>
          </div>
        </div>
        <div class="card-body">
          <div class="regex-matches-list" id="regexMatches" style="min-height:140px;"></div>
        </div>
        <!-- Replace -->
        <div style="border-top:1px solid var(--border);padding:12px 16px;">
          <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px;">Replace</div>
          <div style="display:flex;gap:8px;">
            <input type="text" id="regexReplaceWith" placeholder="Replace with... ($1, $2 for groups)" style="flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-input);color:var(--text-primary);font-family:var(--font-mono);font-size:13px;" oninput="regexReplace()">
            <button class="btn btn-sm" onclick="regexCopyReplaced()">&#x2398; Copy Result</button>
          </div>
          <pre class="output-pre" id="regexReplaceResult" style="min-height:60px;max-height:150px;margin-top:8px;font-size:12px;"></pre>
        </div>
        <!-- Library -->
        <div style="border-top:1px solid var(--border);">
          <button class="settings-toggle" onclick="toggleSettings(this)" style="font-size:12px;">
            <span>&#x1F4DA; Common Patterns</span>
            <span class="chevron">&#x25BC;</span>
          </button>
          <div class="settings-body">
            <div class="regex-library" id="regexLibrary"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════ JWT DECODER TAB ═══════════ -->
  <div class="tab-content" id="tab-jwt">
    <div class="split-pane">
      <!-- JWT Input -->
      <div class="card">
        <div class="card-header">
          <h3>&#x1F511; JWT Token</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm" onclick="jwtLoadSample()">&#x2606; Sample</button>
            <button class="btn btn-sm" onclick="document.getElementById('jwtInput').value='';jwtClearOutput()">&#x2715; Clear</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="jwtInput" placeholder="Paste your JWT token here...&#10;&#10;eyJhbGciOiJIUzI1NiIs..." spellcheck="false" style="min-height:200px;" oninput="jwtDecode()"></textarea>
        </div>
        <!-- Color-coded raw token -->
        <div style="border-top:1px solid var(--border);max-height:150px;overflow-y:auto;">
          <div class="jwt-raw-token" id="jwtRawDisplay"></div>
        </div>
        <div class="stats-bar">
          <span class="stat" id="jwtAlgStat">Algorithm: <span class="stat-value">—</span></span>
          <span class="stat" id="jwtTypeStat">Type: <span class="stat-value">—</span></span>
        </div>
      </div>
      <!-- JWT Decoded -->
      <div class="card">
        <div class="card-header">
          <h3>&#x2B9E; Decoded</h3>
          <div class="card-header-actions">
            <button class="btn btn-sm btn-primary" onclick="jwtCopyDecoded()">&#x2398; Copy Payload</button>
          </div>
        </div>
        <div class="card-body" style="padding:16px;overflow-y:auto;">
          <div class="jwt-parts" id="jwtParts">
            <p style="color:var(--text-secondary);font-style:italic;">Paste a JWT token to decode it</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════ DIFF VIEWER TAB ═══════════ -->
  <div class="tab-content" id="tab-diff">
    <div class="diff-options">
      <label class="checkbox-label" style="font-size:13px;"><input type="checkbox" id="diffIgnoreWs" onchange="diffCompare()" style="width:14px;height:14px;"> Ignore whitespace</label>
      <label class="checkbox-label" style="font-size:13px;"><input type="checkbox" id="diffIgnoreCase" onchange="diffCompare()" style="width:14px;height:14px;"> Ignore case</label>
      <label class="checkbox-label" style="font-size:13px;"><input type="checkbox" id="diffTrimLines" onchange="diffCompare()" style="width:14px;height:14px;"> Trim lines</label>
      <div style="flex:1;"></div>
      <button class="btn btn-sm" onclick="diffSwap()">&#x21C5; Swap</button>
      <button class="btn btn-primary btn-sm" onclick="diffCompare()" style="padding:6px 16px;">&#x26A1; Compare</button>
    </div>
    <div class="compare-grid" style="margin-bottom:16px;">
      <div class="card">
        <div class="card-header">
          <h3>Original (A)</h3>
          <button class="btn btn-sm" onclick="document.getElementById('diffA').value='';diffClearOutput()">&#x2715; Clear</button>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="diffA" placeholder="Paste original text..." spellcheck="false" style="min-height:200px;"></textarea>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Modified (B)</h3>
          <button class="btn btn-sm" onclick="document.getElementById('diffB').value='';diffClearOutput()">&#x2715; Clear</button>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="diffB" placeholder="Paste modified text..." spellcheck="false" style="min-height:200px;"></textarea>
        </div>
      </div>
    </div>
    <!-- Diff output -->
    <div class="diff-output" id="diffOutput" style="display:none;">
      <div class="diff-stats-bar" id="diffStats"></div>
      <div id="diffLines" style="max-height:500px;overflow-y:auto;"></div>
    </div>
  </div>

  <!-- ═══════════ COMPARE TAB ═══════════ -->
  <div class="tab-content" id="tab-compare">
    <div class="compare-grid">
      <div class="card">
        <div class="card-header">
          <h3>List A</h3>
          <button class="btn btn-sm" onclick="document.getElementById('listA').value='';compareNow()">&#x2715; Clear</button>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="listA" placeholder="Paste first list..." spellcheck="false"></textarea>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>List B</h3>
          <button class="btn btn-sm" onclick="document.getElementById('listB').value='';compareNow()">&#x2715; Clear</button>
        </div>
        <div class="card-body">
          <textarea class="editor-area" id="listB" placeholder="Paste second list..." spellcheck="false"></textarea>
        </div>
      </div>
    </div>
    <div style="text-align:center;margin-bottom:20px;">
      <button class="btn btn-primary" onclick="compareNow()" style="padding:12px 32px;font-size:15px;">&#x21C4; Compare Lists</button>
    </div>
    <div class="compare-result" id="compareResult"></div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- ═══════════════════ JAVASCRIPT ═══════════════════ -->
<script>
(() => {
  'use strict';

  /* ────────── State ────────── */
  let debounceTimer = null;

  /* ────────── Theme ────────── */
  function initTheme() {
    const stored = localStorage.getItem('idft-theme');
    if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
    updateThemeIcon();
  }

  window.toggleTheme = function() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('idft-theme', isDark ? 'dark' : 'light');
    updateThemeIcon();
  };

  function updateThemeIcon() {
    const btn = document.getElementById('themeBtn');
    btn.textContent = document.documentElement.classList.contains('dark') ? '\u2600' : '\u263E';
  }

  /* ────────── Tabs ────────── */
  window.switchTab = function(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + name));
  };

  /* ────────── Settings toggle ────────── */
  window.toggleSettings = function(btn) {
    btn.classList.toggle('open');
    btn.nextElementSibling.classList.toggle('open');
  };

  /* ────────── Toast ────────── */
  function toast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = 'toast toast-' + type;
    const icons = { success: '\u2713', error: '\u2717', info: '\u24D8' };
    el.innerHTML = (icons[type] || '') + ' ' + message;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }

  /* ────────── Parse input ────────── */
  function parseRawInput(raw) {
    // Try to detect JSON array
    const trimmed = raw.trim();
    if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
      try {
        const arr = JSON.parse(trimmed);
        if (Array.isArray(arr)) return arr.map(String);
      } catch(e) { /* fall through */ }
    }

    // Try to detect SQL IN clause: strip outer parens
    let working = trimmed;
    if (/^\([\s\S]*\)$/.test(working)) {
      working = working.slice(1, -1);
    }

    // Split by newlines, commas, tabs, semicolons
    let lines = working.split(/[\n\r,;\t]+/);

    // Clean each item
    return lines
      .map(l => l.trim())
      .map(l => l.replace(/^['"`]+|['"`]+$/g, ''))  // strip quotes
      .map(l => l.trim())
      .filter(l => l.length > 0);
  }

  /* ────────── Process items ────────── */
  function processItems(items) {
    const trimWs = document.getElementById('trimWs').checked;
    const dedup = document.getElementById('dedup').checked;
    const caseMode = document.getElementById('caseMode').value;
    const sortMode = document.getElementById('sortMode').value;
    const filterRegex = document.getElementById('filterRegex').value;
    const filterInvert = document.getElementById('filterInvert').checked;
    const prefixVal = document.getElementById('prefix').value;
    const suffixVal = document.getElementById('suffix').value;
    const fnrFind = document.getElementById('fnrFind').value;
    const fnrReplace = document.getElementById('fnrReplace').value;

    // Trim
    if (trimWs) items = items.map(i => i.trim());

    // Filter
    if (filterRegex) {
      try {
        const re = new RegExp(filterRegex);
        items = items.filter(i => filterInvert ? !re.test(i) : re.test(i));
      } catch(e) { /* invalid regex, skip */ }
    }

    // Find & Replace
    if (fnrFind) {
      try {
        const re = new RegExp(fnrFind, 'g');
        items = items.map(i => i.replace(re, fnrReplace));
      } catch(e) { /* skip */ }
    }

    // Case
    if (caseMode === 'upper') items = items.map(i => i.toUpperCase());
    else if (caseMode === 'lower') items = items.map(i => i.toLowerCase());

    // Prefix & Suffix
    if (prefixVal || suffixVal) {
      items = items.map(i => (prefixVal || '') + i + (suffixVal || ''));
    }

    // Stats before dedup
    const totalCount = items.length;

    // Dedup
    let uniqueCount = totalCount;
    if (dedup) {
      const unique = [...new Set(items)];
      uniqueCount = unique.length;
      items = unique;
    }

    // Sort
    if (sortMode === 'asc') items.sort((a, b) => a.localeCompare(b));
    else if (sortMode === 'desc') items.sort((a, b) => b.localeCompare(a));
    else if (sortMode === 'numeric') items.sort((a, b) => Number(a) - Number(b));

    return { items, totalCount, uniqueCount, dupesRemoved: totalCount - uniqueCount };
  }

  /* ────────── Format output ────────── */
  function formatItems(items) {
    const fmt = document.getElementById('outputFormat').value;
    const colName = document.getElementById('colName').value.trim();
    const chunkSize = parseInt(document.getElementById('chunkSize').value) || 0;
    const customTpl = document.getElementById('customTpl').value;

    function applyFormat(arr) {
      switch (fmt) {
        case 'sql-string': {
          const body = '(\n' + arr.map(v => "  '" + v.replace(/'/g, "''") + "'").join(',\n') + '\n)';
          return colName ? 'WHERE ' + colName + ' IN ' + body : body;
        }
        case 'sql-numeric': {
          const body = '(\n' + arr.map(v => '  ' + v).join(',\n') + '\n)';
          return colName ? 'WHERE ' + colName + ' IN ' + body : body;
        }
        case 'csv-quoted':
          return arr.map(v => '"' + v.replace(/"/g, '""') + '"').join(',');
        case 'comma':
          return arr.join(', ');
        case 'json':
          return JSON.stringify(arr, null, 2);
        case 'python':
          return '[\n' + arr.map(v => "  '" + v.replace(/'/g, "\\'") + "'").join(',\n') + '\n]';
        case 'markdown':
          return arr.map(v => '- ' + v).join('\n');
        case 'lines':
          return arr.join('\n');
        case 'custom':
          return arr.map(v => customTpl.replace(/\{value\}/g, v)).join('\n');
        default:
          return arr.join('\n');
      }
    }

    if (chunkSize > 0 && items.length > chunkSize) {
      const chunks = [];
      for (let i = 0; i < items.length; i += chunkSize) {
        chunks.push(items.slice(i, i + chunkSize));
      }
      return chunks.map((chunk, idx) => {
        const header = '-- Chunk ' + (idx + 1) + ' of ' + chunks.length + ' (' + chunk.length + ' items)';
        return header + '\n' + applyFormat(chunk);
      }).join('\n\n');
    }

    return applyFormat(items);
  }

  /* ────────── Main format ────────── */
  window.formatInput = function() {
    const raw = document.getElementById('input').value;
    if (!raw.trim()) {
      document.getElementById('output').textContent = '';
      updateOutputStats(0, 0, 0);
      return;
    }

    const parsed = parseRawInput(raw);
    const { items, totalCount, uniqueCount, dupesRemoved } = processItems(parsed);
    const output = formatItems(items);

    document.getElementById('output').textContent = output;
    updateOutputStats(items.length, uniqueCount, dupesRemoved);
  };

  /* ────────── Stats ────────── */
  function updateInputStats() {
    const raw = document.getElementById('input').value;
    document.getElementById('statLines').textContent = raw ? raw.split('\n').length : 0;
    document.getElementById('statChars').textContent = raw.length;
  }

  function updateOutputStats(total, unique, dupes) {
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statUnique').textContent = unique;
    document.getElementById('statDupes').textContent = dupes;
  }

  /* ────────── Live preview ────────── */
  window.onSettingChange = function() {
    if (document.getElementById('livePreview').checked) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(formatInput, 150);
    }
  };

  /* ────────── Copy ────────── */
  window.copyOutput = function() {
    const text = document.getElementById('output').textContent;
    if (!text.trim()) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(text).then(() => toast('Copied to clipboard!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ────────── Clear ────────── */
  window.clearInput = function() {
    document.getElementById('input').value = '';
    updateInputStats();
    if (document.getElementById('livePreview').checked) formatInput();
  };
  window.clearOutput = function() {
    document.getElementById('output').textContent = '';
    updateOutputStats(0, 0, 0);
  };

  /* ────────── Swap ────────── */
  window.swapPanes = function() {
    const inp = document.getElementById('input');
    const out = document.getElementById('output');
    inp.value = out.textContent;
    out.textContent = '';
    updateInputStats();
    updateOutputStats(0, 0, 0);
    toast('Swapped! Output moved to input.', 'info');
  };

  /* ────────── Download ────────── */
  window.downloadOutput = function() {
    const text = document.getElementById('output').textContent;
    if (!text.trim()) { toast('Nothing to export', 'error'); return; }
    const fmt = document.getElementById('outputFormat').value;
    const exts = { 'sql-string': '.sql', 'sql-numeric': '.sql', 'json': '.json', 'python': '.py', 'markdown': '.md' };
    const ext = exts[fmt] || '.txt';
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'formatted-ids' + ext;
    a.click();
    URL.revokeObjectURL(a.href);
    toast('File downloaded!');
  };

  /* ────────── Drag & Drop ────────── */
  function setupDragDrop() {
    const card = document.getElementById('inputCard');
    const input = document.getElementById('input');

    ['dragenter', 'dragover'].forEach(evt => {
      card.addEventListener(evt, e => { e.preventDefault(); card.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
      card.addEventListener(evt, () => card.classList.remove('drag-over'));
    });
    card.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) { toast('File too large (max 5MB)', 'error'); return; }
      const reader = new FileReader();
      reader.onload = ev => {
        input.value = ev.target.result;
        updateInputStats();
        formatInput();
        toast('File loaded: ' + file.name);
      };
      reader.readAsText(file);
    });
  }

  /* ────────── Compare ────────── */
  window.compareNow = function() {
    const rawA = document.getElementById('listA').value;
    const rawB = document.getElementById('listB').value;
    if (!rawA.trim() && !rawB.trim()) return;

    const setA = new Set(parseRawInput(rawA));
    const setB = new Set(parseRawInput(rawB));

    const intersection = [...setA].filter(x => setB.has(x));
    const onlyA = [...setA].filter(x => !setB.has(x));
    const onlyB = [...setB].filter(x => !setA.has(x));
    const union = [...new Set([...setA, ...setB])];

    function renderCard(title, badge, items) {
      return '<div class="card">' +
        '<div class="card-header"><h3>' + title + ' <span class="result-badge badge-' + badge + '">' + items.length + '</span></h3>' +
        '<button class="btn btn-sm" onclick="copyCompareResult(this)">&#x2398; Copy</button></div>' +
        '<div class="card-body"><pre class="output-pre" style="min-height:120px">' +
        (items.length ? items.join('\n') : '(empty)') +
        '</pre></div></div>';
    }

    document.getElementById('compareResult').innerHTML =
      renderCard('Intersection (A &#x2229; B)', 'intersection', intersection) +
      renderCard('Only in A', 'only-a', onlyA) +
      renderCard('Only in B', 'only-b', onlyB) +
      renderCard('Union (A &#x222A; B)', 'union', union);
  };

  window.copyCompareResult = function(btn) {
    const pre = btn.closest('.card').querySelector('.output-pre');
    navigator.clipboard.writeText(pre.textContent).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ────────── Keyboard Shortcuts ────────── */
  document.addEventListener('keydown', e => {
    // Ctrl+Enter: Format
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      formatInput();
    }
    // Ctrl+Shift+C: Copy output
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      copyOutput();
    }
    // Ctrl+D: Toggle dark mode
    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
      e.preventDefault();
      toggleTheme();
    }
  });

  window.showShortcuts = function() {
    toast('Ctrl+Enter: Format | Ctrl+Shift+C: Copy | Ctrl+D: Dark mode', 'info');
  };

  /* ══════════════════════════════════════════════════════════════
     JSON VALIDATOR / FORMATTER
     ══════════════════════════════════════════════════════════════ */

  let jsonParsed = null;
  let jsonDebounce = null;
  let currentJsonView = 'formatted';

  /* ────────── Auto-validate on input ────────── */
  function setupJsonEvents() {
    const inp = document.getElementById('jsonInput');
    inp.addEventListener('input', () => {
      updateJsonInputStats();
      clearTimeout(jsonDebounce);
      jsonDebounce = setTimeout(jsonFormatNow, 200);
    });
    inp.addEventListener('paste', () => {
      setTimeout(() => { updateJsonInputStats(); jsonFormatNow(); }, 80);
    });

    // Drag & drop for JSON card
    const card = document.getElementById('jsonInputCard');
    ['dragenter', 'dragover'].forEach(evt => {
      card.addEventListener(evt, e => { e.preventDefault(); card.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
      card.addEventListener(evt, () => card.classList.remove('drag-over'));
    });
    card.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) { toast('File too large (max 10MB)', 'error'); return; }
      const reader = new FileReader();
      reader.onload = ev => {
        inp.value = ev.target.result;
        updateJsonInputStats();
        jsonFormatNow();
        toast('File loaded: ' + file.name);
      };
      reader.readAsText(file);
    });
  }

  function updateJsonInputStats() {
    const raw = document.getElementById('jsonInput').value;
    document.getElementById('jsonInputSize').textContent = formatBytes(raw.length);
    document.getElementById('jsonInputLines').textContent = raw ? raw.split('\n').length : 0;
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  /* ────────── Main format/validate ────────── */
  window.jsonFormatNow = function() {
    const raw = document.getElementById('jsonInput').value;
    const statusEl = document.getElementById('jsonStatus');
    const outputEl = document.getElementById('jsonOutput');
    const minEl = document.getElementById('jsonMinified');
    const treeEl = document.getElementById('jsonTree');

    if (!raw.trim()) {
      statusEl.className = 'json-status idle';
      statusEl.innerHTML = '<span class="json-status-icon">\u24D8</span><span>Paste JSON and it will be validated automatically</span>';
      outputEl.innerHTML = '';
      minEl.textContent = '';
      treeEl.innerHTML = '';
      jsonParsed = null;
      updateJsonOutputStats(null);
      return;
    }

    try {
      jsonParsed = JSON.parse(raw);
      statusEl.className = 'json-status valid';
      const typeStr = Array.isArray(jsonParsed) ? 'Array[' + jsonParsed.length + ']' : typeof jsonParsed === 'object' && jsonParsed !== null ? 'Object{' + Object.keys(jsonParsed).length + '}' : typeof jsonParsed;
      statusEl.innerHTML = '<span class="json-status-icon">\u2713</span><span>Valid JSON \u2014 ' + typeStr + '</span>';

      const indent = getJsonIndent();
      let obj = jsonParsed;
      if (document.getElementById('jsonSortKeys').checked) {
        obj = sortKeysDeep(obj);
      }
      const formatted = JSON.stringify(obj, null, indent);
      const minified = JSON.stringify(obj);

      outputEl.innerHTML = syntaxHighlight(formatted);
      minEl.textContent = minified;
      renderJsonTree(treeEl, obj);
      updateJsonOutputStats(obj);
    } catch (err) {
      jsonParsed = null;
      statusEl.className = 'json-status invalid';
      const pos = extractErrorPosition(err.message);
      statusEl.innerHTML = '<span class="json-status-icon">\u2717</span><span>Invalid JSON</span><span class="json-error-detail">' + escapeHtml(err.message) + '</span>';
      outputEl.innerHTML = '';
      minEl.textContent = '';
      treeEl.innerHTML = '';
      updateJsonOutputStats(null);
    }
  };

  function getJsonIndent() {
    const val = document.getElementById('jsonIndent').value;
    return val === 'tab' ? '\t' : parseInt(val);
  }

  function extractErrorPosition(msg) {
    const match = msg.match(/position\s+(\d+)/i);
    return match ? parseInt(match[1]) : -1;
  }

  /* ────────── Sort keys recursively ────────── */
  function sortKeysDeep(obj) {
    if (Array.isArray(obj)) return obj.map(sortKeysDeep);
    if (obj !== null && typeof obj === 'object') {
      const sorted = {};
      Object.keys(obj).sort().forEach(k => { sorted[k] = sortKeysDeep(obj[k]); });
      return sorted;
    }
    return obj;
  }

  /* ────────── Syntax highlighting ────────── */
  function syntaxHighlight(json) {
    return json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
      .replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?|\bnull\b)/g, function(match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  /* ────────── Tree view ────────── */
  function renderJsonTree(container, data) {
    container.innerHTML = '';
    container.appendChild(buildTreeNode(data, '$', '', true));
  }

  function buildTreeNode(value, path, key, isLast) {
    const wrapper = document.createElement('div');

    if (value !== null && typeof value === 'object') {
      const isArr = Array.isArray(value);
      const entries = isArr ? value.map((v, i) => [i, v]) : Object.entries(value);
      const len = entries.length;

      wrapper.className = 'json-tree-expanded';

      const line = document.createElement('div');
      line.className = 'json-tree-line';

      const toggle = document.createElement('span');
      toggle.className = 'json-tree-toggle';
      toggle.onclick = () => {
        wrapper.classList.toggle('json-tree-expanded');
        wrapper.classList.toggle('json-tree-collapsed');
      };
      line.appendChild(toggle);

      if (key !== '') {
        const keySpan = document.createElement('span');
        keySpan.className = 'json-tree-key';
        keySpan.textContent = typeof key === 'string' ? '"' + key + '"' : key;
        keySpan.onclick = () => jsonSetPath(path);
        line.appendChild(keySpan);
        const colon = document.createElement('span');
        colon.className = 'json-tree-colon';
        colon.textContent = ':';
        line.appendChild(colon);
      }

      const bracket = document.createElement('span');
      bracket.className = 'json-bracket';
      bracket.textContent = isArr ? '[' : '{';
      line.appendChild(bracket);

      const preview = document.createElement('span');
      preview.className = 'json-tree-preview';
      preview.textContent = ' ' + len + (len === 1 ? ' item' : ' items') + ' ';
      preview.style.display = 'none';
      line.appendChild(preview);

      // Show preview when collapsed
      const origToggle = toggle.onclick;
      toggle.onclick = () => {
        wrapper.classList.toggle('json-tree-expanded');
        wrapper.classList.toggle('json-tree-collapsed');
        preview.style.display = wrapper.classList.contains('json-tree-collapsed') ? 'inline' : 'none';
      };

      wrapper.appendChild(line);

      const children = document.createElement('div');
      children.className = 'json-tree-children json-tree-node';
      entries.forEach(([k, v], idx) => {
        const childPath = isArr ? path + '[' + k + ']' : path + '.' + k;
        children.appendChild(buildTreeNode(v, childPath, k, idx === len - 1));
      });
      wrapper.appendChild(children);

      const closingLine = document.createElement('div');
      const closingBracket = document.createElement('span');
      closingBracket.className = 'json-bracket';
      closingBracket.textContent = (isArr ? ']' : '}') + (isLast ? '' : ',');
      closingLine.appendChild(closingBracket);
      wrapper.appendChild(closingLine);
    } else {
      const line = document.createElement('div');
      const indent = document.createElement('span');
      indent.style.display = 'inline-block';
      indent.style.width = '18px';
      line.appendChild(indent);

      if (key !== '') {
        const keySpan = document.createElement('span');
        keySpan.className = 'json-tree-key';
        keySpan.textContent = typeof key === 'string' ? '"' + key + '"' : key;
        keySpan.onclick = () => jsonSetPath(path);
        line.appendChild(keySpan);
        const colon = document.createElement('span');
        colon.className = 'json-tree-colon';
        colon.textContent = ':';
        line.appendChild(colon);
      }

      const valSpan = document.createElement('span');
      if (value === null) { valSpan.className = 'json-null'; valSpan.textContent = 'null'; }
      else if (typeof value === 'boolean') { valSpan.className = 'json-boolean'; valSpan.textContent = String(value); }
      else if (typeof value === 'number') { valSpan.className = 'json-number'; valSpan.textContent = String(value); }
      else { valSpan.className = 'json-string'; valSpan.textContent = '"' + String(value) + '"'; }
      line.appendChild(valSpan);

      if (!isLast) {
        const comma = document.createElement('span');
        comma.className = 'json-tree-comma';
        comma.textContent = ',';
        line.appendChild(comma);
      }

      wrapper.appendChild(line);
    }

    return wrapper;
  }

  function jsonSetPath(path) {
    const display = document.getElementById('jsonPathDisplay');
    display.textContent = path;
    navigator.clipboard.writeText(path).then(() => toast('Path copied: ' + path, 'info')).catch(() => {});
  }

  /* ────────── JSON stats ────────── */
  function updateJsonOutputStats(obj) {
    if (!obj) {
      document.getElementById('jsonStatKeys').textContent = '0';
      document.getElementById('jsonStatDepth').textContent = '0';
      document.getElementById('jsonStatSize').textContent = '0 B';
      return;
    }
    document.getElementById('jsonStatKeys').textContent = countKeys(obj);
    document.getElementById('jsonStatDepth').textContent = calcDepth(obj);
    document.getElementById('jsonStatSize').textContent = formatBytes(JSON.stringify(obj).length);
  }

  function countKeys(obj) {
    let count = 0;
    if (Array.isArray(obj)) { obj.forEach(v => { count += countKeys(v); }); }
    else if (obj !== null && typeof obj === 'object') {
      const keys = Object.keys(obj);
      count += keys.length;
      keys.forEach(k => { count += countKeys(obj[k]); });
    }
    return count;
  }

  function calcDepth(obj, d) {
    d = d || 0;
    if (Array.isArray(obj)) {
      if (obj.length === 0) return d + 1;
      return Math.max(...obj.map(v => calcDepth(v, d + 1)));
    }
    if (obj !== null && typeof obj === 'object') {
      const vals = Object.values(obj);
      if (vals.length === 0) return d + 1;
      return Math.max(...vals.map(v => calcDepth(v, d + 1)));
    }
    return d;
  }

  /* ────────── JSON view switching ────────── */
  window.jsonSwitchView = function(view) {
    currentJsonView = view;
    document.querySelectorAll('.json-view-tab').forEach(t => t.classList.toggle('active', t.dataset.jview === view));
    document.getElementById('jsonViewFormatted').style.display = view === 'formatted' ? 'flex' : 'none';
    document.getElementById('jsonViewMinified').style.display = view === 'minified' ? 'flex' : 'none';
    document.getElementById('jsonViewTree').style.display = view === 'tree' ? 'flex' : 'none';
  };

  /* ────────── JSON copy ────────── */
  window.jsonCopyOutput = function() {
    let text = '';
    if (currentJsonView === 'minified') {
      text = document.getElementById('jsonMinified').textContent;
    } else if (jsonParsed !== null) {
      const indent = getJsonIndent();
      let obj = jsonParsed;
      if (document.getElementById('jsonSortKeys').checked) obj = sortKeysDeep(obj);
      text = JSON.stringify(obj, null, indent);
    }
    if (!text.trim()) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(text).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ────────── JSON download ────────── */
  window.jsonDownload = function() {
    if (!jsonParsed) { toast('No valid JSON to export', 'error'); return; }
    const indent = getJsonIndent();
    let obj = jsonParsed;
    if (document.getElementById('jsonSortKeys').checked) obj = sortKeysDeep(obj);
    const text = currentJsonView === 'minified' ? JSON.stringify(obj) : JSON.stringify(obj, null, indent);
    const blob = new Blob([text], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'formatted.json';
    a.click();
    URL.revokeObjectURL(a.href);
    toast('JSON file downloaded!');
  };

  /* ────────── JSON clear ────────── */
  window.jsonClearOutput = function() {
    document.getElementById('jsonOutput').innerHTML = '';
    document.getElementById('jsonMinified').textContent = '';
    document.getElementById('jsonTree').innerHTML = '';
    jsonParsed = null;
    updateJsonOutputStats(null);
    updateJsonInputStats();
    const s = document.getElementById('jsonStatus');
    s.className = 'json-status idle';
    s.innerHTML = '<span class="json-status-icon">\u24D8</span><span>Paste JSON and it will be validated automatically</span>';
    document.getElementById('jsonPathDisplay').textContent = '$';
  };

  /* ────────── JSON auto-fix ────────── */
  window.jsonFixInput = function() {
    let raw = document.getElementById('jsonInput').value;
    if (!raw.trim()) { toast('Nothing to fix', 'error'); return; }

    let fixed = raw;
    // Replace single quotes with double quotes (careful with content)
    fixed = fixed.replace(/'/g, '"');
    // Remove trailing commas before } or ]
    fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
    // Add quotes to unquoted keys: key: -> "key":
    fixed = fixed.replace(/([{,]\s*)([a-zA-Z_$][\w$]*)(\s*:)/g, '$1"$2"$3');
    // Remove JS-style comments
    fixed = fixed.replace(/\/\/.*$/gm, '');
    fixed = fixed.replace(/\/\*[\s\S]*?\*\//g, '');

    document.getElementById('jsonInput').value = fixed;
    updateJsonInputStats();
    jsonFormatNow();

    if (jsonParsed) {
      toast('JSON fixed and formatted!');
    } else {
      toast('Attempted fixes but JSON is still invalid', 'error');
    }
  };

  /* ────────── JSON sample ────────── */
  window.jsonLoadSample = function() {
    const sample = {
      "name": "ID Formatter Toolkit",
      "version": "2.0.0",
      "features": ["format", "compare", "json-validator"],
      "config": {
        "theme": "auto",
        "livePreview": true,
        "maxFileSize": "5MB"
      },
      "stats": {
        "formats": 9,
        "users": null,
        "isOpenSource": true
      },
      "tags": [
        { "id": 1, "label": "productivity" },
        { "id": 2, "label": "developer-tools" },
        { "id": 3, "label": "formatter" }
      ]
    };
    document.getElementById('jsonInput').value = JSON.stringify(sample, null, 2);
    updateJsonInputStats();
    jsonFormatNow();
    toast('Sample JSON loaded', 'info');
  };

  /* ══════════════════════════════════════════════════════════════
     MARKDOWN VIEWER / EDITOR
     ══════════════════════════════════════════════════════════════ */

  let mdDebounce = null;
  let mdMermaidId = 0;

  function setupMarkdown() {
    // Init mermaid
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({ startOnLoad: false, theme: document.documentElement.classList.contains('dark') ? 'dark' : 'default', securityLevel: 'loose' });
    }

    // Configure marked
    function mdSlugify(text) {
      return text.toLowerCase().replace(/<[^>]*>/g, '').replace(/[^\w]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function mdHighlight(code, lang) {
      if (typeof hljs === 'undefined') return code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      try {
        if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
        return hljs.highlightAuto(code).value;
      } catch(e) { return code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    }

    if (typeof marked !== 'undefined') {
      marked.use({
        gfm: true,
        breaks: false,
        renderer: {
          heading({ tokens, depth }) {
            const text = this.parser.parseInline(tokens);
            const slug = mdSlugify(text);
            return '<h' + depth + ' id="md-' + slug + '">' + text + '</h' + depth + '>\n';
          },
          code({ text, lang }) {
            const language = (lang || '').split(/\s/)[0];
            if (language === 'mermaid') {
              const escaped = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
              return '<div class="mermaid-container mermaid-pending" data-mermaid-source="' + escaped + '">Loading diagram...</div>\n';
            }
            const highlighted = mdHighlight(text, language);
            const copyIcon = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
            return '<pre><div class="code-header"><span class="code-lang">' + (language || 'code') + '</span><button class="copy-btn" onclick="mdCopyCode(this)">' + copyIcon + ' Copy</button></div><code class="hljs language-' + language + '">' + highlighted + '</code></pre>\n';
          },
          listitem({ text, task, checked }) {
            if (task) return '<li class="task-list-item"><input type="checkbox" ' + (checked ? 'checked' : '') + ' disabled>' + text + '</li>\n';
            return '<li>' + text + '</li>\n';
          }
        }
      });
    }

    // Input events
    const inp = document.getElementById('mdInput');
    inp.addEventListener('input', () => {
      updateMdStats();
      clearTimeout(mdDebounce);
      mdDebounce = setTimeout(mdRender, 200);
    });
    inp.addEventListener('paste', () => {
      setTimeout(() => { updateMdStats(); mdRender(); }, 80);
    });

    // File drop on input card
    const card = document.getElementById('mdInputCard');
    ['dragenter', 'dragover'].forEach(evt => {
      card.addEventListener(evt, e => { e.preventDefault(); card.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
      card.addEventListener(evt, () => card.classList.remove('drag-over'));
    });
    card.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file) mdLoadFile(file);
    });

    // Drop zone in upload mode
    const dropZone = document.getElementById('mdDropZone');
    ['dragenter', 'dragover'].forEach(evt => {
      dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
      dropZone.addEventListener(evt, () => dropZone.classList.remove('drag-over'));
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file) mdLoadFile(file);
    });

    // File input
    document.getElementById('mdFileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) mdLoadFile(file);
      e.target.value = '';
    });

    updateMdStats();
  }

  function mdLoadFile(file) {
    if (file.size > 5 * 1024 * 1024) { toast('File too large (max 5MB)', 'error'); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('mdInput').value = ev.target.result;
      document.getElementById('mdFileName').textContent = file.name;
      document.getElementById('mdFileInfo').style.display = 'flex';
      updateMdStats();
      mdRender();
      toast('Loaded: ' + file.name);
    };
    reader.readAsText(file);
  }

  window.mdSwitchInput = function(mode) {
    document.querySelectorAll('#mdInputToggle button').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    document.getElementById('mdWriteMode').style.display = mode === 'write' ? 'block' : 'none';
    document.getElementById('mdUploadMode').style.display = mode === 'upload' ? 'flex' : 'none';
  };

  function mdRender() {
    const raw = document.getElementById('mdInput').value;
    const preview = document.getElementById('mdPreview');
    if (!raw.trim()) {
      preview.innerHTML = '<p style="color:var(--text-secondary);font-style:italic;">Start typing markdown to see the preview...</p>';
      document.getElementById('mdTocList').innerHTML = '';
      return;
    }
    if (typeof marked === 'undefined') {
      preview.innerHTML = '<p style="color:var(--bg-danger);">marked.js library not loaded. Check your internet connection.</p>';
      return;
    }
    preview.innerHTML = marked.parse(raw);
    mdBuildToc();
    mdRenderMermaid();
  }

  async function mdRenderMermaid() {
    if (typeof mermaid === 'undefined') return;
    const preview = document.getElementById('mdPreview');
    const blocks = preview.querySelectorAll('.mermaid-pending');
    if (!blocks.length) return;
    const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'default';
    mermaid.initialize({ startOnLoad: false, theme: theme, securityLevel: 'loose' });
    for (const block of blocks) {
      const code = block.getAttribute('data-mermaid-source');
      const id = 'md-mermaid-' + (++mdMermaidId);
      try {
        const result = await mermaid.render(id, code);
        block.innerHTML = result.svg;
        block.classList.remove('mermaid-pending');
      } catch(err) {
        block.innerHTML = '<pre style="color:var(--bg-danger);text-align:left;font-size:12px;">Mermaid Error: ' + err.message + '</pre>';
        block.classList.remove('mermaid-pending');
      }
    }
  }

  function mdBuildToc() {
    const preview = document.getElementById('mdPreview');
    const tocList = document.getElementById('mdTocList');
    const headings = preview.querySelectorAll('h1, h2, h3, h4');
    tocList.innerHTML = '';
    headings.forEach(h => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      const level = parseInt(h.tagName[1]);
      a.href = '#' + h.id;
      a.textContent = h.textContent.trim();
      a.className = 'toc-h' + level;
      a.onclick = e => { e.preventDefault(); h.scrollIntoView({ behavior: 'smooth', block: 'start' }); };
      li.appendChild(a);
      tocList.appendChild(li);
    });
  }

  window.mdToggleToc = function() {
    const toc = document.getElementById('mdToc');
    const visible = toc.style.display !== 'none';
    toc.style.display = visible ? 'none' : 'block';
  };

  window.mdCopyCode = function(btn) {
    const pre = btn.closest('pre');
    const code = pre.querySelector('code');
    navigator.clipboard.writeText(code.textContent).then(() => {
      btn.classList.add('copied');
      const orig = btn.innerHTML;
      btn.innerHTML = '\u2713 Copied!';
      setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = orig; }, 2000);
    }).catch(() => toast('Copy failed', 'error'));
  };

  function updateMdStats() {
    const raw = document.getElementById('mdInput').value;
    document.getElementById('mdStatLines').textContent = raw ? raw.split('\n').length : 0;
    document.getElementById('mdStatWords').textContent = raw.trim() ? raw.trim().split(/\s+/).length : 0;
    document.getElementById('mdStatChars').textContent = raw.length;
  }

  window.mdClear = function() {
    document.getElementById('mdInput').value = '';
    document.getElementById('mdPreview').innerHTML = '<p style="color:var(--text-secondary);font-style:italic;">Start typing markdown to see the preview...</p>';
    document.getElementById('mdTocList').innerHTML = '';
    document.getElementById('mdFileInfo').style.display = 'none';
    updateMdStats();
  };

  window.mdCopyHtml = function() {
    const html = document.getElementById('mdPreview').innerHTML;
    if (!html || html.includes('Start typing')) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(html).then(() => toast('HTML copied!')).catch(() => toast('Copy failed', 'error'));
  };

  window.mdDownloadHtml = function() {
    const body = document.getElementById('mdPreview').innerHTML;
    if (!body || body.includes('Start typing')) { toast('Nothing to export', 'error'); return; }
    const full = '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<title>Markdown Export</title>\n<style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;max-width:800px;margin:40px auto;padding:0 20px;line-height:1.7;color:#1a1a2e;}pre{background:#f6f8fa;padding:16px;border-radius:8px;overflow-x:auto;}code{font-family:monospace;background:#f6f8fa;padding:2px 5px;border-radius:4px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #e2e8f0;padding:8px 12px;text-align:left;}th{background:#f1f5f9;}blockquote{border-left:4px solid #6366f1;margin:0;padding:8px 16px;background:#f8f7ff;}img{max-width:100%;}</style>\n</head>\n<body>\n' + body + '\n</body>\n</html>';
    const blob = new Blob([full], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'markdown-export.html';
    a.click();
    URL.revokeObjectURL(a.href);
    toast('HTML file downloaded!');
  };

  window.mdLoadSample = function() {
    const sample = `# Welcome to Markdown Preview

## Features

This editor supports **full GFM** (GitHub Flavored Markdown):

### Text Formatting
- **Bold**, *italic*, ~~strikethrough~~
- [Links](https://example.com) and \`inline code\`

### Task List
- [x] Write markdown
- [x] See live preview
- [ ] Export to HTML

### Code Block
\`\`\`javascript
function greet(name) {
  return \`Hello, \${name}!\`;
}
console.log(greet('World'));
\`\`\`

### Table

| Feature | Status |
|---------|--------|
| GFM Tables | ✅ |
| Syntax Highlighting | ✅ |
| Mermaid Diagrams | ✅ |
| Task Lists | ✅ |
| Live Preview | ✅ |

### Blockquote

> "The best way to predict the future is to invent it."
> — Alan Kay

### Mermaid Diagram
\`\`\`mermaid
graph TD
    A[Write Markdown] --> B{Preview}
    B --> C[Export HTML]
    B --> D[Copy HTML]
    C --> E[Share!]
    D --> E
\`\`\`

---

*Powered by marked.js, highlight.js & mermaid*
`;
    document.getElementById('mdInput').value = sample;
    updateMdStats();
    mdRender();
    toast('Sample markdown loaded', 'info');
  };

  /* ══════════════════════════════════════════════════════════════
     BASE64 / URL / HTML ENCODE-DECODE
     ══════════════════════════════════════════════════════════════ */

  let encMode = 'base64';
  let encDir = 'encode';

  window.encSwitchMode = function(mode) {
    encMode = mode;
    document.querySelectorAll('#encModeBar button').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    if (document.getElementById('encLive').checked) encProcess();
  };

  window.encSetDir = function(dir) {
    encDir = dir;
    document.getElementById('encBtnEncode').classList.toggle('active', dir === 'encode');
    document.getElementById('encBtnDecode').classList.toggle('active', dir === 'decode');
    if (document.getElementById('encLive').checked) encProcess();
  };

  window.encProcess = function() {
    const input = document.getElementById('encInput').value;
    const outEl = document.getElementById('encOutput');
    document.getElementById('encInputChars').textContent = input.length;
    document.getElementById('encInputBytes').textContent = new Blob([input]).size;

    if (!input) {
      outEl.textContent = '';
      document.getElementById('encOutputChars').textContent = '0';
      document.getElementById('encOutputBytes').textContent = '0';
      return;
    }

    let result = '';
    try {
      if (encMode === 'base64') {
        if (encDir === 'encode') {
          result = btoa(unescape(encodeURIComponent(input)));
        } else {
          result = decodeURIComponent(escape(atob(input.trim())));
        }
      } else if (encMode === 'url') {
        result = encDir === 'encode' ? encodeURIComponent(input) : decodeURIComponent(input);
      } else if (encMode === 'html') {
        if (encDir === 'encode') {
          result = input.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        } else {
          const el = document.createElement('textarea');
          el.innerHTML = input;
          result = el.value;
        }
      }
    } catch(e) {
      result = 'Error: ' + e.message;
    }

    outEl.textContent = result;
    document.getElementById('encOutputChars').textContent = result.length;
    document.getElementById('encOutputBytes').textContent = new Blob([result]).size;
  };

  window.encSwap = function() {
    const inp = document.getElementById('encInput');
    const out = document.getElementById('encOutput');
    inp.value = out.textContent;
    out.textContent = '';
    encDir = encDir === 'encode' ? 'decode' : 'encode';
    document.getElementById('encBtnEncode').classList.toggle('active', encDir === 'encode');
    document.getElementById('encBtnDecode').classList.toggle('active', encDir === 'decode');
    if (document.getElementById('encLive').checked) encProcess();
    toast('Swapped!', 'info');
  };

  window.encCopy = function() {
    const text = document.getElementById('encOutput').textContent;
    if (!text) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(text).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ══════════════════════════════════════════════════════════════
     REGEX TESTER
     ══════════════════════════════════════════════════════════════ */

  const REGEX_LIBRARY = [
    { name: 'Email', pattern: '[\\w.-]+@[\\w.-]+\\.\\w{2,}' },
    { name: 'URL', pattern: 'https?://[\\w\\-._~:/?#\\[\\]@!$&\'()*+,;=%]+' },
    { name: 'IPv4 Address', pattern: '\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b' },
    { name: 'Phone (US)', pattern: '\\(?\\d{3}\\)?[-.\\s]?\\d{3}[-.\\s]?\\d{4}' },
    { name: 'Hex Color', pattern: '#(?:[0-9a-fA-F]{3}){1,2}\\b' },
    { name: 'Date (YYYY-MM-DD)', pattern: '\\d{4}-\\d{2}-\\d{2}' },
    { name: 'Time (HH:MM:SS)', pattern: '\\d{1,2}:\\d{2}(?::\\d{2})?' },
    { name: 'UUID', pattern: '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' },
    { name: 'Integer', pattern: '-?\\d+' },
    { name: 'Decimal', pattern: '-?\\d+\\.\\d+' },
    { name: 'HTML Tag', pattern: '<[^>]+>' },
    { name: 'Quoted String', pattern: '(["\'])(?:(?!\\1).)*\\1' },
    { name: 'Whitespace Lines', pattern: '^\\s*$' },
    { name: 'Camel → Words', pattern: '(?<=[a-z])(?=[A-Z])' },
    { name: 'File Extension', pattern: '\\.([a-zA-Z0-9]+)$' },
    { name: 'JSON Key', pattern: '"(\\w+)"\\s*:' },
  ];

  function setupRegex() {
    const lib = document.getElementById('regexLibrary');
    lib.innerHTML = REGEX_LIBRARY.map((r, i) =>
      '<div class="regex-lib-item" onclick="regexLoadLib(' + i + ')">' +
        '<div class="lib-name">' + r.name + '</div>' +
        '<div class="lib-pattern">/' + r.pattern.replace(/</g,'&lt;') + '/</div>' +
      '</div>'
    ).join('');
  }

  window.regexLoadLib = function(idx) {
    document.getElementById('regexPattern').value = REGEX_LIBRARY[idx].pattern;
    regexTest();
  };

  window.regexToggleFlag = function(btn) {
    btn.classList.toggle('active');
    regexTest();
  };

  function getRegexFlags() {
    return Array.from(document.querySelectorAll('.regex-flag.active')).map(b => b.dataset.flag).join('');
  }

  window.regexTest = function() {
    const pattern = document.getElementById('regexPattern').value;
    const testStr = document.getElementById('regexTestStr').value;
    const highlightEl = document.getElementById('regexHighlight');
    const matchesEl = document.getElementById('regexMatches');
    const countEl = document.getElementById('regexMatchCount');

    if (!pattern || !testStr) {
      highlightEl.innerHTML = escapeHtmlText(testStr);
      matchesEl.innerHTML = '';
      countEl.textContent = '0 matches';
      regexReplace();
      return;
    }

    let regex;
    try {
      regex = new RegExp(pattern, getRegexFlags());
    } catch(e) {
      highlightEl.innerHTML = escapeHtmlText(testStr);
      matchesEl.innerHTML = '<div style="padding:12px;color:var(--bg-danger);font-size:13px;">' + escapeHtmlText(e.message) + '</div>';
      countEl.textContent = 'Error';
      return;
    }

    // Collect matches
    const matches = [];
    let match;
    const isGlobal = regex.global;
    if (isGlobal) {
      while ((match = regex.exec(testStr)) !== null) {
        matches.push({ index: match.index, length: match[0].length, value: match[0], groups: match.slice(1) });
        if (match[0].length === 0) regex.lastIndex++;
      }
    } else {
      match = regex.exec(testStr);
      if (match) {
        matches.push({ index: match.index, length: match[0].length, value: match[0], groups: match.slice(1) });
      }
    }

    countEl.textContent = matches.length + (matches.length === 1 ? ' match' : ' matches');

    // Highlight
    let html = '';
    let last = 0;
    matches.forEach(m => {
      html += escapeHtmlText(testStr.slice(last, m.index));
      html += '<span class="regex-match-hl">' + escapeHtmlText(m.value) + '</span>';
      last = m.index + m.length;
    });
    html += escapeHtmlText(testStr.slice(last));
    highlightEl.innerHTML = html;

    // Match list
    if (matches.length === 0) {
      matchesEl.innerHTML = '<div style="padding:16px;color:var(--text-secondary);font-size:13px;text-align:center;">No matches found</div>';
    } else {
      matchesEl.innerHTML = matches.slice(0, 200).map((m, i) => {
        let groupsHtml = '';
        if (m.groups.length) {
          groupsHtml = m.groups.map((g, gi) =>
            '<span class="regex-match-group">$' + (gi+1) + '="' + escapeHtmlText(g || '') + '"</span>'
          ).join(' ');
        }
        return '<div class="regex-match-item">' +
          '<span class="regex-match-idx">#' + (i+1) + ' @' + m.index + '</span>' +
          '<span class="regex-match-val">' + escapeHtmlText(m.value) + '</span>' +
          (groupsHtml ? '<span>' + groupsHtml + '</span>' : '') +
        '</div>';
      }).join('') + (matches.length > 200 ? '<div style="padding:8px 12px;font-size:12px;color:var(--text-secondary);">... and ' + (matches.length - 200) + ' more</div>' : '');
    }

    regexReplace();
  };

  function escapeHtmlText(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  window.regexReplace = function() {
    const pattern = document.getElementById('regexPattern').value;
    const testStr = document.getElementById('regexTestStr').value;
    const replaceWith = document.getElementById('regexReplaceWith').value;
    const resultEl = document.getElementById('regexReplaceResult');

    if (!pattern || !testStr) { resultEl.textContent = ''; return; }

    try {
      const regex = new RegExp(pattern, getRegexFlags());
      resultEl.textContent = testStr.replace(regex, replaceWith);
    } catch(e) {
      resultEl.textContent = '';
    }
  };

  window.regexCopyMatches = function() {
    const items = document.querySelectorAll('.regex-match-val');
    if (!items.length) { toast('No matches', 'error'); return; }
    const text = Array.from(items).map(el => el.textContent).join('\n');
    navigator.clipboard.writeText(text).then(() => toast('Matches copied!')).catch(() => toast('Copy failed', 'error'));
  };

  window.regexCopyReplaced = function() {
    const text = document.getElementById('regexReplaceResult').textContent;
    if (!text) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(text).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ══════════════════════════════════════════════════════════════
     JWT DECODER
     ══════════════════════════════════════════════════════════════ */

  let jwtDecoded = null;

  window.jwtDecode = function() {
    const raw = document.getElementById('jwtInput').value.trim();
    const partsEl = document.getElementById('jwtParts');
    const rawDisplay = document.getElementById('jwtRawDisplay');

    if (!raw) {
      partsEl.innerHTML = '<p style="color:var(--text-secondary);font-style:italic;">Paste a JWT token to decode it</p>';
      rawDisplay.innerHTML = '';
      jwtDecoded = null;
      jwtUpdateStats(null, null);
      return;
    }

    const parts = raw.split('.');
    if (parts.length !== 3) {
      partsEl.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;padding:8px;">Invalid JWT: Expected 3 parts (header.payload.signature), got ' + parts.length + '</div>';
      rawDisplay.innerHTML = '<span style="color:var(--bg-danger);">' + escapeHtmlText(raw) + '</span>';
      jwtDecoded = null;
      jwtUpdateStats(null, null);
      return;
    }

    // Color-coded raw
    rawDisplay.innerHTML =
      '<span class="jwt-header-seg">' + escapeHtmlText(parts[0]) + '</span>' +
      '<span class="jwt-dot">.</span>' +
      '<span class="jwt-payload-seg">' + escapeHtmlText(parts[1]) + '</span>' +
      '<span class="jwt-dot">.</span>' +
      '<span class="jwt-sig-seg">' + escapeHtmlText(parts[2]) + '</span>';

    let header, payload;
    try {
      header = JSON.parse(jwtBase64Decode(parts[0]));
    } catch(e) {
      partsEl.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;padding:8px;">Failed to decode header: ' + escapeHtmlText(e.message) + '</div>';
      return;
    }
    try {
      payload = JSON.parse(jwtBase64Decode(parts[1]));
    } catch(e) {
      partsEl.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;padding:8px;">Failed to decode payload: ' + escapeHtmlText(e.message) + '</div>';
      return;
    }

    jwtDecoded = { header, payload };
    jwtUpdateStats(header, payload);

    // Build decoded view
    let html = '';

    // Header
    html += '<div class="jwt-part-card jwt-header-part">' +
      '<div class="jwt-part-header"><span>HEADER</span><button class="btn btn-sm" onclick="jwtCopyPart(\'header\')" style="font-size:11px;">&#x2398; Copy</button></div>' +
      '<div class="jwt-part-body"><pre>' + jwtSyntaxHighlight(JSON.stringify(header, null, 2)) + '</pre></div></div>';

    // Payload
    html += '<div class="jwt-part-card jwt-payload-part">' +
      '<div class="jwt-part-header"><span>PAYLOAD</span><button class="btn btn-sm" onclick="jwtCopyPart(\'payload\')" style="font-size:11px;">&#x2398; Copy</button></div>' +
      '<div class="jwt-part-body"><pre>' + jwtSyntaxHighlight(JSON.stringify(payload, null, 2)) + '</pre></div></div>';

    // Claims table
    const knownClaims = {
      iss: 'Issuer', sub: 'Subject', aud: 'Audience', exp: 'Expiration',
      nbf: 'Not Before', iat: 'Issued At', jti: 'JWT ID',
      name: 'Name', email: 'Email', role: 'Role', scope: 'Scope',
    };

    html += '<div class="jwt-part-card" style="border-color:var(--border);">' +
      '<div class="jwt-part-header" style="background:var(--bg-input);color:var(--text-primary);"><span>CLAIMS</span></div>' +
      '<div class="jwt-part-body" style="padding:0;"><table class="jwt-claims-table">';

    for (const [key, val] of Object.entries(payload)) {
      let display = '';
      const claimName = knownClaims[key] || key;

      if ((key === 'exp' || key === 'nbf' || key === 'iat') && typeof val === 'number') {
        const d = new Date(val * 1000);
        display = escapeHtmlText(d.toLocaleString()) + ' <span style="color:var(--text-secondary);font-size:11px;">(' + d.toISOString() + ')</span>';
        if (key === 'exp') {
          const now = Date.now() / 1000;
          if (val < now) {
            display += ' <span class="jwt-expiry-badge jwt-expiry-expired">\u2717 Expired</span>';
          } else {
            display += ' <span class="jwt-expiry-badge jwt-expiry-valid">\u2713 Valid</span>';
          }
        }
      } else if (typeof val === 'object') {
        display = '<code style="font-size:12px;">' + escapeHtmlText(JSON.stringify(val)) + '</code>';
      } else {
        display = escapeHtmlText(String(val));
      }

      html += '<tr><td>' + escapeHtmlText(claimName) + ' <span style="font-size:10px;color:var(--text-secondary);">(' + escapeHtmlText(key) + ')</span></td><td>' + display + '</td></tr>';
    }

    html += '</table></div></div>';

    // Signature
    html += '<div class="jwt-part-card jwt-sig-part">' +
      '<div class="jwt-part-header"><span>SIGNATURE</span></div>' +
      '<div class="jwt-part-body"><pre style="font-size:12px;color:var(--text-secondary);word-break:break-all;">' + escapeHtmlText(parts[2]) + '</pre>' +
      '<p style="font-size:12px;color:var(--text-secondary);margin-top:8px;">Signature verification requires the secret/key and is not performed client-side.</p></div></div>';

    partsEl.innerHTML = html;
  };

  function jwtBase64Decode(str) {
    // Handle URL-safe base64
    let s = str.replace(/-/g, '+').replace(/_/g, '/');
    while (s.length % 4) s += '=';
    return decodeURIComponent(escape(atob(s)));
  }

  function jwtSyntaxHighlight(json) {
    return json.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?|\bnull\b)/g, function(match) {
        let cls = 'json-number';
        if (/^"/.test(match)) { cls = /:$/.test(match) ? 'json-key' : 'json-string'; }
        else if (/true|false/.test(match)) cls = 'json-boolean';
        else if (/null/.test(match)) cls = 'json-null';
        return '<span class="' + cls + '">' + match + '</span>';
      });
  }

  function jwtUpdateStats(header, payload) {
    const algEl = document.getElementById('jwtAlgStat');
    const typEl = document.getElementById('jwtTypeStat');
    if (!header) {
      algEl.innerHTML = 'Algorithm: <span class="stat-value">\u2014</span>';
      typEl.innerHTML = 'Type: <span class="stat-value">\u2014</span>';
    } else {
      algEl.innerHTML = 'Algorithm: <span class="stat-value">' + escapeHtmlText(header.alg || '?') + '</span>';
      typEl.innerHTML = 'Type: <span class="stat-value">' + escapeHtmlText(header.typ || '?') + '</span>';
    }
  }

  window.jwtCopyPart = function(part) {
    if (!jwtDecoded) return;
    const obj = part === 'header' ? jwtDecoded.header : jwtDecoded.payload;
    navigator.clipboard.writeText(JSON.stringify(obj, null, 2)).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  window.jwtCopyDecoded = function() {
    if (!jwtDecoded) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(JSON.stringify(jwtDecoded.payload, null, 2)).then(() => toast('Payload copied!')).catch(() => toast('Copy failed', 'error'));
  };

  window.jwtClearOutput = function() {
    document.getElementById('jwtParts').innerHTML = '<p style="color:var(--text-secondary);font-style:italic;">Paste a JWT token to decode it</p>';
    document.getElementById('jwtRawDisplay').innerHTML = '';
    jwtDecoded = null;
    jwtUpdateStats(null, null);
  };

  window.jwtLoadSample = function() {
    // Build a sample JWT (not signed, just for demo)
    const header = { alg: 'HS256', typ: 'JWT' };
    const payload = {
      sub: '1234567890', name: 'Jane Developer', email: 'jane@example.com',
      role: 'admin', iat: Math.floor(Date.now() / 1000) - 3600,
      exp: Math.floor(Date.now() / 1000) + 86400,
      iss: 'dev-toolkit', aud: 'api.example.com', jti: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
    };
    function b64url(obj) {
      return btoa(JSON.stringify(obj)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    }
    const token = b64url(header) + '.' + b64url(payload) + '.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
    document.getElementById('jwtInput').value = token;
    jwtDecode();
    toast('Sample JWT loaded', 'info');
  };

  /* ══════════════════════════════════════════════════════════════
     DIFF VIEWER
     ══════════════════════════════════════════════════════════════ */

  window.diffCompare = function() {
    const rawA = document.getElementById('diffA').value;
    const rawB = document.getElementById('diffB').value;
    const outputEl = document.getElementById('diffOutput');
    const linesEl = document.getElementById('diffLines');
    const statsEl = document.getElementById('diffStats');

    if (!rawA && !rawB) { outputEl.style.display = 'none'; return; }

    const ignoreWs = document.getElementById('diffIgnoreWs').checked;
    const ignoreCase = document.getElementById('diffIgnoreCase').checked;
    const trimLines = document.getElementById('diffTrimLines').checked;

    let linesA = rawA.split('\n');
    let linesB = rawB.split('\n');

    function normalize(line) {
      let l = line;
      if (trimLines) l = l.trim();
      if (ignoreCase) l = l.toLowerCase();
      if (ignoreWs) l = l.replace(/\s+/g, ' ').trim();
      return l;
    }

    // LCS-based diff (Myers-like, simplified)
    const normA = linesA.map(normalize);
    const normB = linesB.map(normalize);
    const diff = computeLCS(normA, normB, linesA, linesB);

    let added = 0, deleted = 0, same = 0;
    let html = '';
    let lineNumA = 0, lineNumB = 0;

    diff.forEach(d => {
      if (d.type === 'same') {
        same++;
        lineNumA++; lineNumB++;
        html += '<div class="diff-line diff-line-ctx">' +
          '<div class="diff-gutter">' + lineNumA + '</div>' +
          '<div class="diff-gutter">' + lineNumB + '</div>' +
          '<div class="diff-content"> ' + escapeHtmlText(d.line) + '</div></div>';
      } else if (d.type === 'del') {
        deleted++;
        lineNumA++;
        html += '<div class="diff-line diff-line-del">' +
          '<div class="diff-gutter">' + lineNumA + '</div>' +
          '<div class="diff-gutter"></div>' +
          '<div class="diff-content">-' + escapeHtmlText(d.line) + '</div></div>';
      } else if (d.type === 'add') {
        added++;
        lineNumB++;
        html += '<div class="diff-line diff-line-add">' +
          '<div class="diff-gutter"></div>' +
          '<div class="diff-gutter">' + lineNumB + '</div>' +
          '<div class="diff-content">+' + escapeHtmlText(d.line) + '</div></div>';
      }
    });

    statsEl.innerHTML =
      '<span class="diff-stat-add">+' + added + ' added</span>' +
      '<span class="diff-stat-del">-' + deleted + ' removed</span>' +
      '<span class="diff-stat-same">' + same + ' unchanged</span>' +
      '<span class="stat" style="margin-left:auto;">Total: ' + (linesA.length) + ' → ' + (linesB.length) + ' lines</span>';

    linesEl.innerHTML = html;
    outputEl.style.display = 'block';
  };

  function computeLCS(normA, normB, origA, origB) {
    const m = normA.length;
    const n = normB.length;

    // Build LCS table
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (normA[i-1] === normB[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
        else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
      }
    }

    // Backtrack to produce diff
    const result = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && normA[i-1] === normB[j-1]) {
        result.unshift({ type: 'same', line: origA[i-1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || dp[i][j-1] >= dp[i-1][j])) {
        result.unshift({ type: 'add', line: origB[j-1] });
        j--;
      } else {
        result.unshift({ type: 'del', line: origA[i-1] });
        i--;
      }
    }

    return result;
  }

  window.diffSwap = function() {
    const a = document.getElementById('diffA');
    const b = document.getElementById('diffB');
    const tmp = a.value;
    a.value = b.value;
    b.value = tmp;
    diffCompare();
    toast('Swapped!', 'info');
  };

  window.diffClearOutput = function() {
    document.getElementById('diffOutput').style.display = 'none';
    document.getElementById('diffLines').innerHTML = '';
    document.getElementById('diffStats').innerHTML = '';
  };

  /* ══════════════════════════════════════════════════════════════
     EPOCH CONVERTER
     ══════════════════════════════════════════════════════════════ */

  let epochClockInterval = null;

  function setupEpoch() {
    epochClockInterval = setInterval(updateEpochClock, 1000);
    updateEpochClock();
  }

  function updateEpochClock() {
    const now = new Date();
    const ts = Math.floor(now.getTime() / 1000);
    const el = document.getElementById('epochLive');
    const elH = document.getElementById('epochLiveHuman');
    const elU = document.getElementById('epochLiveUTC');
    if (el) el.textContent = ts;
    if (elH) elH.textContent = now.toLocaleString();
    if (elU) elU.textContent = 'UTC: ' + now.toISOString();
  }

  window.epochCopyNow = function() {
    const ts = Math.floor(Date.now() / 1000);
    navigator.clipboard.writeText(String(ts)).then(() => toast('Copied: ' + ts)).catch(() => toast('Copy failed', 'error'));
  };

  /* ── Epoch → Human ── */
  function detectEpochUnit(val) {
    const n = Number(val);
    if (isNaN(n)) return null;
    // Nanoseconds: > 1e18
    if (n > 1e18) return { seconds: n / 1e9, unit: 'ns' };
    // Microseconds: > 1e15
    if (n > 1e15) return { seconds: n / 1e6, unit: 'us' };
    // Milliseconds: > 1e12
    if (n > 1e12) return { seconds: n / 1e3, unit: 'ms' };
    // Seconds
    return { seconds: n, unit: 's' };
  }

  function epochToSeconds(val, unit) {
    const n = Number(val);
    if (isNaN(n)) return null;
    if (unit === 'auto') {
      const detected = detectEpochUnit(val);
      return detected ? detected.seconds : null;
    }
    switch (unit) {
      case 's': return n;
      case 'ms': return n / 1e3;
      case 'us': return n / 1e6;
      case 'ns': return n / 1e9;
    }
    return n;
  }

  window.epochToHuman = function() {
    const raw = document.getElementById('epochToHumanInput').value.trim();
    const unit = document.getElementById('epochToHumanUnit').value;
    const container = document.getElementById('epochToHumanResults');
    const relEl = document.getElementById('epochRelative');

    if (!raw) { container.innerHTML = ''; relEl.style.display = 'none'; return; }

    const secs = epochToSeconds(raw, unit);
    if (secs === null) {
      container.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;">Invalid timestamp</div>';
      relEl.style.display = 'none';
      return;
    }

    const date = new Date(secs * 1000);
    if (isNaN(date.getTime())) {
      container.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;">Invalid date from timestamp</div>';
      relEl.style.display = 'none';
      return;
    }

    const detected = unit === 'auto' ? detectEpochUnit(raw) : null;
    const detectedLabel = detected ? ' <span style="font-size:11px;color:var(--text-secondary);">(detected: ' + detected.unit + ')</span>' : '';

    const rows = [
      { label: 'Local', value: date.toLocaleString() },
      { label: 'UTC', value: date.toUTCString() },
      { label: 'ISO 8601', value: date.toISOString() },
      { label: 'Date Only', value: date.toLocaleDateString('en-CA') },
      { label: 'Time Only', value: date.toLocaleTimeString() },
      { label: 'Day of Week', value: date.toLocaleDateString('en-US', { weekday: 'long' }) },
      { label: 'Seconds', value: String(Math.floor(secs)) },
      { label: 'Milliseconds', value: String(Math.floor(secs * 1000)) },
    ];

    container.innerHTML = detectedLabel + rows.map(r =>
      '<div class="epoch-result-row">' +
        '<span class="epoch-label">' + r.label + '</span>' +
        '<span class="epoch-value">' + r.value + '</span>' +
        '<button class="btn btn-sm" onclick="epochCopyVal(this)" title="Copy">&#x2398;</button>' +
      '</div>'
    ).join('');

    // Relative time
    const diff = secs - Date.now() / 1000;
    relEl.style.display = 'block';
    relEl.textContent = formatRelativeTime(diff);
  };

  function formatRelativeTime(diffSec) {
    const abs = Math.abs(diffSec);
    const past = diffSec < 0;
    let str = '';
    if (abs < 60) str = Math.floor(abs) + ' seconds';
    else if (abs < 3600) str = Math.floor(abs / 60) + ' minutes, ' + Math.floor(abs % 60) + ' seconds';
    else if (abs < 86400) str = Math.floor(abs / 3600) + ' hours, ' + Math.floor((abs % 3600) / 60) + ' minutes';
    else if (abs < 2592000) str = Math.floor(abs / 86400) + ' days, ' + Math.floor((abs % 86400) / 3600) + ' hours';
    else if (abs < 31536000) str = Math.floor(abs / 2592000) + ' months, ' + Math.floor((abs % 2592000) / 86400) + ' days';
    else str = Math.floor(abs / 31536000) + ' years, ' + Math.floor((abs % 31536000) / 2592000) + ' months';
    return past ? str + ' ago' : 'in ' + str;
  }

  window.epochSetQuick = function(val) {
    document.getElementById('epochToHumanInput').value = val;
    epochToHuman();
  };

  window.epochCopyVal = function(btn) {
    const val = btn.previousElementSibling.textContent;
    navigator.clipboard.writeText(val).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ── Human → Epoch ── */
  window.humanToEpoch = function() {
    const val = document.getElementById('humanToEpochInput').value;
    if (!val) { document.getElementById('humanToEpochResults').innerHTML = ''; return; }
    const date = new Date(val);
    renderHumanToEpoch(date);
  };

  window.humanToEpochFromText = function() {
    const val = document.getElementById('humanToEpochText').value.trim();
    if (!val) { document.getElementById('humanToEpochResults').innerHTML = ''; return; }
    const date = new Date(val);
    renderHumanToEpoch(date);
  };

  function renderHumanToEpoch(date) {
    const container = document.getElementById('humanToEpochResults');
    if (isNaN(date.getTime())) {
      container.innerHTML = '<div style="color:var(--bg-danger);font-size:13px;">Could not parse date</div>';
      return;
    }

    const secs = Math.floor(date.getTime() / 1000);
    const ms = date.getTime();

    const rows = [
      { label: 'Seconds', value: String(secs) },
      { label: 'Milliseconds', value: String(ms) },
      { label: 'ISO 8601', value: date.toISOString() },
      { label: 'UTC', value: date.toUTCString() },
      { label: 'Local', value: date.toLocaleString() },
    ];

    container.innerHTML = rows.map(r =>
      '<div class="epoch-result-row">' +
        '<span class="epoch-label">' + r.label + '</span>' +
        '<span class="epoch-value">' + r.value + '</span>' +
        '<button class="btn btn-sm" onclick="epochCopyVal(this)" title="Copy">&#x2398;</button>' +
      '</div>'
    ).join('');
  }

  window.humanSetQuick = function(preset) {
    const now = new Date();
    let target;
    switch (preset) {
      case 'now': target = now; break;
      case 'today': target = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
      case 'tomorrow': target = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1); break;
      case 'week': target = new Date(now.getTime() + 7 * 86400000); break;
      case 'month': target = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate()); break;
      case 'year': target = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate()); break;
      default: target = now;
    }
    // Set datetime-local input
    const iso = new Date(target.getTime() - target.getTimezoneOffset() * 60000).toISOString().slice(0, 19);
    document.getElementById('humanToEpochInput').value = iso;
    document.getElementById('humanToEpochText').value = '';
    humanToEpoch();
  };

  /* ── Batch Convert ── */
  window.epochBatchConvert = function() {
    const dir = document.getElementById('epochBatchDir').value;
    const raw = document.getElementById('epochBatchInput').value;
    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    if (!lines.length) { toast('Nothing to convert', 'error'); return; }

    const results = lines.map(line => {
      if (dir === 'toHuman') {
        const secs = epochToSeconds(line, 'auto');
        if (secs === null) return line + ' → (invalid)';
        const d = new Date(secs * 1000);
        if (isNaN(d.getTime())) return line + ' → (invalid date)';
        return line + ' → ' + d.toISOString() + ' (' + d.toLocaleString() + ')';
      } else {
        const d = new Date(line);
        if (isNaN(d.getTime())) return line + ' → (could not parse)';
        return line + ' → ' + Math.floor(d.getTime() / 1000);
      }
    });

    document.getElementById('epochBatchOutput').textContent = results.join('\n');
    toast('Converted ' + lines.length + ' entries!');
  };

  window.epochBatchCopy = function() {
    const text = document.getElementById('epochBatchOutput').textContent;
    if (!text.trim()) { toast('Nothing to copy', 'error'); return; }
    navigator.clipboard.writeText(text).then(() => toast('Copied!')).catch(() => toast('Copy failed', 'error'));
  };

  /* ────────── URL State ────────── */
  function saveStateToUrl() {
    const params = new URLSearchParams();
    const fields = ['outputFormat', 'sortMode', 'caseMode', 'chunkSize', 'colName', 'prefix', 'suffix', 'filterRegex', 'customTpl'];
    fields.forEach(id => {
      const val = document.getElementById(id).value;
      if (val && val !== '0' && val !== 'none' && val !== 'asis') params.set(id, val);
    });
    ['dedup', 'trimWs', 'livePreview', 'filterInvert'].forEach(id => {
      const el = document.getElementById(id);
      if (!el.checked) params.set(id, '0');
    });
    const qs = params.toString();
    if (qs) history.replaceState(null, '', '?' + qs);
    else history.replaceState(null, '', location.pathname);
  }

  function loadStateFromUrl() {
    const params = new URLSearchParams(location.search);
    params.forEach((val, key) => {
      const el = document.getElementById(key);
      if (!el) return;
      if (el.type === 'checkbox') el.checked = val !== '0';
      else el.value = val;
    });
  }

  /* ────────── Auto-format on paste ────────── */
  document.getElementById('input').addEventListener('paste', () => {
    setTimeout(() => { updateInputStats(); formatInput(); }, 80);
  });

  /* ────────── Input events ────────── */
  document.getElementById('input').addEventListener('input', () => {
    updateInputStats();
    onSettingChange();
  });

  /* ────────── Save settings on change (wrap original) ────────── */
  const origOnSettingChange = window.onSettingChange;
  window.onSettingChange = function() {
    origOnSettingChange();
    saveStateToUrl();
  };

  /* ────────── Init ────────── */
  initTheme();
  loadStateFromUrl();
  setupDragDrop();
  setupJsonEvents();
  setupMarkdown();
  setupRegex();
  setupEpoch();
  updateInputStats();
  updateJsonInputStats();

})();
</script>
</body>
</html>
